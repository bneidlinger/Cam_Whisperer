<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PlatoniCam // SECURITY SYSTEMS OPTIMIZATION TERMINAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“·</text></svg>" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

    :root {
      /* 80's Industrial Color Palette */
      --bg-primary: #0a0a0a;
      --bg-secondary: #121212;
      --bg-panel: #1a1a1a;
      --orange-primary: #ff6b1a;
      --orange-glow: #ff8c42;
      --orange-dark: #cc5515;
      --orange-border: #2a1a0f;
      --green-terminal: #00ff41;
      --amber-warning: #ffaa00;
      --red-alert: #ff4444;
      --blue-info: #00d4ff;
      --grid-line: #1a1a1a;
      --text-primary: #e8e8e8;
      --text-dim: #888888;
      --text-orange: #ff8c42;
      --scan-line: rgba(255, 107, 26, 0.03);
      --sidebar-width: 200px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Share Tech Mono', 'Courier New', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* CRT Scan Lines Effect */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        var(--scan-line) 2px,
        var(--scan-line) 4px
      );
      pointer-events: none;
      z-index: 1000;
      opacity: 0.5;
    }

    /* Grid Background */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(var(--grid-line) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
      background-size: 20px 20px;
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
    }

    /* Main Layout */
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* Terminal Header */
    .terminal-header {
      background: linear-gradient(180deg, var(--bg-panel) 0%, var(--bg-secondary) 100%);
      border-bottom: 3px solid var(--orange-primary);
      padding: 12px 20px;
      position: relative;
      box-shadow:
        0 0 20px rgba(255, 107, 26, 0.3),
        inset 0 1px 0 rgba(255, 140, 66, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .terminal-header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--orange-glow);
      box-shadow: 0 0 10px var(--orange-glow);
    }

    .system-title {
      font-size: 1.4rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-orange);
      text-shadow: 0 0 10px rgba(255, 107, 26, 0.5);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--green-terminal);
      box-shadow:
        0 0 10px var(--green-terminal),
        0 0 20px var(--green-terminal),
        inset 0 0 5px rgba(255, 255, 255, 0.5);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Recording indicator - red pulsing for emergency mode */
    .status-indicator.recording {
      background: var(--red-alert);
      box-shadow:
        0 0 10px var(--red-alert),
        0 0 20px var(--red-alert),
        inset 0 0 5px rgba(255, 255, 255, 0.5);
      animation: pulse-recording 1s ease-in-out infinite;
    }

    @keyframes pulse-recording {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    .emergency-record-indicator {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid var(--red-alert);
      border-radius: 4px;
      padding: 4px 8px;
    }

    .emergency-recording-badge {
      background: var(--red-alert);
      animation: pulse-recording 1s ease-in-out infinite;
    }

    /* Emergency section specific styles */
    .snapshot-thumbnail {
      position: relative;
      aspect-ratio: 16/9;
      overflow: hidden;
      border: 1px solid var(--orange-dark);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .snapshot-thumbnail:hover {
      border-color: var(--orange-primary);
    }

    .snapshot-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .snapshot-thumbnail-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 8px;
      font-size: 0.65rem;
    }

    .snapshot-thumbnail-camera {
      color: var(--orange-glow);
    }

    .snapshot-thumbnail-time {
      color: var(--text-dim);
    }

    .camera-status-card {
      background: var(--bg-primary);
      border: 1px solid var(--orange-dark);
      border-radius: 4px;
      padding: 10px;
      text-align: center;
    }

    .camera-status-card.active {
      border-color: var(--green-terminal);
    }

    .camera-status-card.failed {
      border-color: var(--red-alert);
    }

    .header-stats {
      display: flex;
      gap: 20px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .header-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-stat-value {
      color: var(--orange-glow);
    }

    /* Main Content Area */
    .main-content {
      display: flex;
      flex: 1;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-panel);
      border-right: 2px solid var(--orange-dark);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-nav {
      flex: 1;
      padding: 10px 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s;
      color: var(--text-dim);
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.1em;
    }

    .nav-item:hover {
      background: rgba(255, 107, 26, 0.1);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(255, 107, 26, 0.15);
      border-left-color: var(--orange-primary);
      color: var(--orange-glow);
      box-shadow: inset 0 0 20px rgba(255, 107, 26, 0.1);
    }

    .nav-icon {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .nav-label {
      flex: 1;
    }

    .nav-badge {
      background: var(--orange-dark);
      color: var(--text-primary);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.65rem;
    }

    .sidebar-footer {
      padding: 15px;
      border-top: 1px solid var(--orange-dark);
      font-size: 0.65rem;
      color: var(--text-dim);
      text-align: center;
    }

    /* Content Area */
    .content-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      max-height: calc(100vh - 70px);
    }

    /* Section Containers */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Panel Styling */
    .panel {
      background: var(--bg-panel);
      border: 2px solid var(--orange-dark);
      position: relative;
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.7),
        inset 0 1px 0 rgba(255, 107, 26, 0.1);
      margin-bottom: 20px;
    }

    .panel::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg,
        transparent,
        var(--orange-primary) 20%,
        var(--orange-primary) 80%,
        transparent
      );
      opacity: 0.6;
    }

    .panel-header {
      background: linear-gradient(180deg, #1f1f1f 0%, var(--bg-secondary) 100%);
      padding: 10px 16px;
      border-bottom: 1px solid var(--orange-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-orange);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title::before {
      content: ">";
      color: var(--orange-primary);
      font-size: 0.7rem;
    }

    .panel-body {
      padding: 20px;
    }

    /* Sub-tabs */
    .sub-tabs {
      display: flex;
      border-bottom: 1px solid var(--orange-dark);
      background: var(--bg-secondary);
    }

    .sub-tab {
      padding: 10px 20px;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .sub-tab:hover {
      color: var(--text-primary);
      background: rgba(255, 107, 26, 0.05);
    }

    .sub-tab.active {
      color: var(--orange-glow);
      border-bottom-color: var(--orange-primary);
      background: rgba(255, 107, 26, 0.1);
    }

    .sub-content {
      display: none;
    }

    .sub-content.active {
      display: block;
    }

    /* Form Styling */
    .form-section {
      margin-bottom: 20px;
    }

    .section-header {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--orange-glow);
      border-left: 3px solid var(--orange-primary);
      padding-left: 8px;
      margin-bottom: 12px;
      text-shadow: 0 0 5px rgba(255, 107, 26, 0.3);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
    }

    input, select, textarea {
      background: var(--bg-secondary);
      border: 1px solid #333;
      border-bottom: 2px solid var(--orange-dark);
      color: var(--text-primary);
      padding: 8px 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-bottom-color: var(--orange-primary);
      box-shadow: 0 0 10px rgba(255, 107, 26, 0.2);
      background: #1a1a1a;
    }

    input::placeholder {
      color: #444;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Button Styling */
    .btn {
      background: linear-gradient(180deg, var(--orange-primary) 0%, var(--orange-dark) 100%);
      color: #000;
      border: none;
      padding: 12px 24px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.85rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      position: relative;
      box-shadow:
        0 4px 15px rgba(255, 107, 26, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.2s;
      border: 1px solid var(--orange-glow);
    }

    .btn::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.2), transparent);
      pointer-events: none;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow:
        0 6px 20px rgba(255, 107, 26, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(180deg, #333 0%, #222 100%);
      color: var(--text-primary);
      border-color: #444;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }

    .btn-secondary:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.75rem;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: var(--bg-secondary);
      border: 1px solid var(--orange-dark);
      border-radius: 2px;
    }

    .status-badge.loading {
      border-color: var(--amber-warning);
      color: var(--amber-warning);
    }

    .status-badge.success {
      border-color: var(--green-terminal);
      color: var(--green-terminal);
    }

    .status-badge.error {
      border-color: var(--red-alert);
      color: var(--red-alert);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 8px currentColor;
    }

    /* Output Terminal */
    .output-terminal {
      background: #000;
      border: 2px solid var(--orange-dark);
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      max-height: 500px;
      overflow-y: auto;
      position: relative;
      box-shadow: inset 0 0 20px rgba(255, 107, 26, 0.1);
    }

    .output-terminal::before {
      content: "SYSTEM OUTPUT";
      position: absolute;
      top: 4px;
      left: 4px;
      font-size: 0.6rem;
      color: var(--orange-dark);
      letter-spacing: 0.1em;
    }

    .output-content {
      color: var(--green-terminal);
      text-shadow: 0 0 3px var(--green-terminal);
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 20px;
    }

    .output-terminal::-webkit-scrollbar {
      width: 8px;
    }

    .output-terminal::-webkit-scrollbar-track {
      background: #000;
    }

    .output-terminal::-webkit-scrollbar-thumb {
      background: var(--orange-dark);
      border: 1px solid var(--orange-primary);
    }

    /* JSON Output Styling */
    .json-key { color: var(--orange-glow); }
    .json-string { color: var(--green-terminal); }
    .json-number { color: var(--amber-warning); }
    .json-bool { color: var(--blue-info); }

    /* Settings Report Styling */
    .settings-report {
      color: var(--green-terminal);
      text-shadow: 0 0 3px var(--green-terminal);
      margin-top: 20px;
    }

    .settings-report-header {
      border-bottom: 1px solid var(--orange-dark);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .settings-report-title {
      color: var(--orange-glow);
      font-size: 1rem;
      font-weight: bold;
      letter-spacing: 0.1em;
    }

    .settings-report-meta {
      display: flex;
      gap: 20px;
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .settings-report-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .settings-report-meta-label {
      color: var(--text-dim);
    }

    .settings-report-meta-value {
      color: var(--green-terminal);
    }

    .settings-report-meta-value.high { color: #00ff41; }
    .settings-report-meta-value.medium { color: var(--amber-warning); }
    .settings-report-meta-value.low { color: #ff4444; }

    .settings-category {
      margin-bottom: 20px;
    }

    .settings-category-header {
      color: var(--orange-primary);
      font-size: 0.85rem;
      font-weight: bold;
      margin-bottom: 8px;
      padding: 4px 0;
      border-bottom: 1px dashed var(--orange-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-category-icon {
      font-size: 0.9rem;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px 20px;
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 4px 0;
      border-bottom: 1px dotted rgba(255, 107, 26, 0.2);
    }

    .settings-item-label {
      color: var(--text-dim);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .settings-item-value {
      color: var(--green-terminal);
      font-size: 0.85rem;
      font-weight: bold;
      text-align: right;
    }

    .settings-item-value.highlight {
      color: var(--amber-warning);
    }

    .settings-explanation {
      margin-top: 20px;
      padding: 12px;
      background: rgba(255, 107, 26, 0.05);
      border-left: 3px solid var(--orange-dark);
    }

    .settings-explanation-header {
      color: var(--orange-primary);
      font-size: 0.75rem;
      font-weight: bold;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .settings-explanation-text {
      color: var(--text-primary);
      font-size: 0.8rem;
      line-height: 1.6;
    }

    .settings-warnings {
      margin-top: 15px;
      padding: 10px;
      background: rgba(255, 165, 0, 0.1);
      border: 1px solid var(--amber-warning);
    }

    .settings-warnings-header {
      color: var(--amber-warning);
      font-size: 0.75rem;
      font-weight: bold;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .settings-warning-item {
      color: var(--amber-warning);
      font-size: 0.8rem;
      padding: 4px 0;
      padding-left: 15px;
      position: relative;
    }

    .settings-warning-item::before {
      content: "!";
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    /* Image Upload */
    .upload-zone {
      border: 2px dashed var(--orange-dark);
      background: var(--bg-secondary);
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-zone:hover {
      border-color: var(--orange-primary);
      background: #1a1a1a;
      box-shadow: 0 0 15px rgba(255, 107, 26, 0.2);
    }

    .upload-icon {
      font-size: 2rem;
      color: var(--orange-primary);
      margin-bottom: 10px;
    }

    .upload-text {
      font-size: 0.8rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Table Styling */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .data-table th {
      background: var(--bg-secondary);
      color: var(--orange-glow);
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      padding: 10px;
      text-align: left;
      border-bottom: 2px solid var(--orange-dark);
    }

    .data-table td {
      padding: 10px;
      border-bottom: 1px solid #333;
      color: var(--text-primary);
    }

    .data-table tr:hover {
      background: rgba(255, 107, 26, 0.05);
    }

    .data-table .status-online {
      color: var(--green-terminal);
    }

    .data-table .status-offline {
      color: var(--red-alert);
    }

    /* Card Grid */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .camera-card {
      background: var(--bg-panel);
      border: 1px solid var(--orange-dark);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .camera-card:hover {
      border-color: var(--orange-primary);
      box-shadow: 0 0 20px rgba(255, 107, 26, 0.2);
      transform: translateY(-2px);
    }

    .camera-card-header {
      background: var(--bg-secondary);
      padding: 12px;
      border-bottom: 1px solid var(--orange-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .camera-card-id {
      font-size: 0.85rem;
      color: var(--orange-glow);
      font-weight: bold;
    }

    .camera-card-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green-terminal);
      box-shadow: 0 0 8px var(--green-terminal);
    }

    .camera-card-status.warning {
      background: var(--amber-warning);
      box-shadow: 0 0 8px var(--amber-warning);
    }

    .camera-card-status.error {
      background: var(--red-alert);
      box-shadow: 0 0 8px var(--red-alert);
    }

    .camera-card-body {
      padding: 12px;
    }

    .camera-card-location {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-bottom: 12px;
    }

    .camera-card-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .camera-card-stat {
      font-size: 0.7rem;
    }

    .camera-card-stat-label {
      color: var(--text-dim);
      text-transform: uppercase;
    }

    .camera-card-stat-value {
      color: var(--text-primary);
      font-size: 0.85rem;
    }

    .confidence-high { color: var(--green-terminal); }
    .confidence-medium { color: var(--amber-warning); }
    .confidence-low { color: var(--red-alert); }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 500;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-panel);
      border: 2px solid var(--orange-primary);
      max-width: 800px;
      max-height: 90vh;
      width: 100%;
      overflow-y: auto;
      box-shadow: 0 0 40px rgba(255, 107, 26, 0.3);
    }

    .modal-header {
      background: var(--bg-secondary);
      padding: 15px 20px;
      border-bottom: 1px solid var(--orange-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      color: var(--orange-glow);
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0 5px;
    }

    .modal-close:hover {
      color: var(--orange-primary);
    }

    .modal-body {
      padding: 20px;
    }

    /* Health Gauge */
    .health-gauge {
      width: 100px;
      height: 100px;
      position: relative;
      display: inline-block;
    }

    .health-gauge-circle {
      transform: rotate(-90deg);
    }

    .health-gauge-bg {
      fill: none;
      stroke: #333;
      stroke-width: 8;
    }

    .health-gauge-fill {
      fill: none;
      stroke: var(--green-terminal);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s;
    }

    .health-gauge-fill.warning {
      stroke: var(--amber-warning);
    }

    .health-gauge-fill.error {
      stroke: var(--red-alert);
    }

    .health-gauge-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2rem;
      color: var(--text-primary);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    .empty-state-icon {
      font-size: 3rem;
      color: var(--orange-dark);
      margin-bottom: 20px;
    }

    .empty-state-text {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* Calculator Results */
    .result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .result-item {
      background: var(--bg-secondary);
      border: 1px solid var(--orange-dark);
      padding: 15px;
      border-radius: 4px;
    }

    .result-item.result-highlight {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, rgba(255, 107, 26, 0.15), rgba(255, 107, 26, 0.05));
      border-color: var(--orange-primary);
    }

    .result-label {
      font-size: 0.7rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    .result-value {
      font-size: 1.4rem;
      color: var(--orange-glow);
      font-weight: bold;
    }

    .result-value.result-big {
      font-size: 2rem;
      text-shadow: 0 0 10px rgba(255, 107, 26, 0.5);
    }

    /* Grid layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 800px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Responsive sidebar */
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }
      .nav-label, .nav-badge {
        display: none;
      }
      .nav-icon {
        font-size: 1.4rem;
      }
      .nav-item {
        justify-content: center;
        padding: 14px 10px;
      }
      .site-controls {
        display: none;
      }
    }

    /* Site Controls */
    .site-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 30px;
      padding-left: 20px;
      border-left: 1px solid var(--orange-dark);
    }

    .site-selector {
      background: var(--bg-secondary);
      border: 1px solid var(--orange-dark);
      color: var(--text-orange);
      padding: 6px 12px;
      min-width: 180px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .site-selector:focus {
      outline: none;
      border-color: var(--orange-primary);
      box-shadow: 0 0 10px rgba(255, 107, 26, 0.2);
    }

    .site-selector option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .site-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--orange-dark);
      color: var(--text-primary);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.75rem;
      font-family: 'Share Tech Mono', monospace;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .site-btn:hover {
      border-color: var(--orange-primary);
      color: var(--orange-glow);
      box-shadow: 0 0 10px rgba(255, 107, 26, 0.2);
    }

    .site-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .site-name-display {
      color: var(--text-dim);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Site Modal specific styles */
    .site-modal-input {
      width: 100%;
      margin-bottom: 15px;
    }

    .site-modal-textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    /* Hidden file input for site import */
    #site-import-input {
      display: none;
    }

    /* ========== MQTT Events Section Styles ========== */

    /* MQTT Status Badge States */
    #mqtt-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      font-size: 0.7rem;
      text-transform: uppercase;
      background: var(--bg-secondary);
      border: 1px solid var(--text-dim);
      border-radius: 2px;
    }

    #mqtt-status-badge.connected {
      border-color: var(--green-terminal);
      color: var(--green-terminal);
    }

    #mqtt-status-badge.connecting {
      border-color: var(--amber-warning);
      color: var(--amber-warning);
    }

    #mqtt-status-badge.disconnected {
      border-color: var(--text-dim);
      color: var(--text-dim);
    }

    #mqtt-status-badge.error {
      border-color: var(--red-alert);
      color: var(--red-alert);
    }

    #mqtt-status-badge .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    #mqtt-status-badge.connected .status-dot {
      box-shadow: 0 0 6px var(--green-terminal);
      animation: pulse 2s ease-in-out infinite;
    }

    /* Event Type Badges */
    .event-type-badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-radius: 2px;
      background: var(--bg-primary);
      border: 1px solid var(--orange-dark);
      color: var(--text-primary);
    }

    .event-type-badge.event-motion {
      border-color: var(--blue-info);
      color: var(--blue-info);
    }

    .event-type-badge.event-alert {
      border-color: var(--red-alert);
      color: var(--red-alert);
      animation: alertPulse 1s ease-in-out infinite;
    }

    .event-type-badge.event-crossing {
      border-color: var(--amber-warning);
      color: var(--amber-warning);
    }

    .event-type-badge.event-face {
      border-color: #a855f7;
      color: #a855f7;
    }

    @keyframes alertPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Event Log Item */
    .event-log-item {
      padding: 10px 15px;
      border-bottom: 1px solid var(--bg-primary);
      transition: background 0.2s;
    }

    .event-log-item:hover {
      background: rgba(255, 107, 26, 0.05);
    }

    .event-log-item:last-child {
      border-bottom: none;
    }

    /* MQTT Camera Item */
    .mqtt-camera-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--bg-secondary);
      margin-bottom: 8px;
      border-radius: 4px;
    }

    .mqtt-camera-item:hover {
      border-color: var(--orange-dark);
    }

    /* TLS/Security Indicators */
    .tls-valid {
      color: var(--green-terminal);
    }

    .tls-warning {
      color: var(--amber-warning);
    }

    .tls-invalid {
      color: var(--red-alert);
    }

    .discovery-enabled {
      color: var(--amber-warning);
    }

    .discovery-disabled {
      color: var(--green-terminal);
    }

    /* Security info in camera cards */
    .security-info {
      font-size: 0.75rem;
      display: grid;
      gap: 4px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--bg-secondary);
    }

    .security-info-row {
      display: flex;
      justify-content: space-between;
    }

    .security-info-label {
      color: var(--text-dim);
    }

    .btn-xs {
      padding: 3px 8px;
      font-size: 0.65rem;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Terminal Header -->
    <header class="terminal-header">
      <div style="display: flex; align-items: center;">
        <div class="system-title">
          <span class="status-indicator"></span>
          PlatoniCam // SURVEILLANCE OPTIMIZATION
        </div>
        <div class="site-controls">
          <select class="site-selector" id="site-selector" title="Select Site">
            <option value="">-- No Site --</option>
          </select>
          <button class="site-btn" id="new-site-btn" title="Create New Site">[+] NEW</button>
          <button class="site-btn" id="save-site-btn" title="Export Site to JSON" disabled>[S] SAVE</button>
          <button class="site-btn" id="load-site-btn" title="Import Site from JSON">[L] LOAD</button>
          <button class="site-btn" id="delete-site-btn" title="Delete Current Site" disabled>[X] DEL</button>
        </div>
        <input type="file" id="site-import-input" accept=".json" />
      </div>
      <div class="header-stats">
        <div class="header-stat">
          <span>CAMERAS:</span>
          <span class="header-stat-value" id="camera-count">0</span>
        </div>
        <div class="header-stat">
          <span>OPTIMIZED:</span>
          <span class="header-stat-value" id="optimized-count">0</span>
        </div>
        <div class="header-stat">
          <span>HEALTH:</span>
          <span class="header-stat-value" id="health-status">--</span>
        </div>
        <div class="header-stat emergency-record-indicator" id="emergency-record-indicator" style="display: none;" title="Emergency Recording Active">
          <span class="status-indicator recording"></span>
          <span style="color: var(--red-alert);">REC</span>
          <span class="header-stat-value" id="emergency-record-camera-count">0</span>
        </div>
        <a href="landing.html" class="header-stat" style="color: var(--orange-glow); text-decoration: none; cursor: pointer;" title="Open Optimization Guide">
          <span>[?] GUIDE</span>
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Sidebar Navigation -->
      <nav class="sidebar">
        <div class="sidebar-nav">
          <div class="nav-item active" data-section="import">
            <span class="nav-icon">+</span>
            <span class="nav-label">Import</span>
          </div>
          <div class="nav-item" data-section="optimize">
            <span class="nav-icon">*</span>
            <span class="nav-label">Optimize</span>
          </div>
          <div class="nav-item" data-section="results">
            <span class="nav-icon">#</span>
            <span class="nav-label">Results</span>
            <span class="nav-badge" id="results-badge">0</span>
          </div>
          <div class="nav-item" data-section="health">
            <span class="nav-icon">~</span>
            <span class="nav-label">Health</span>
          </div>
          <div class="nav-item" data-section="events">
            <span class="nav-icon">!</span>
            <span class="nav-label">Events</span>
            <span class="nav-badge" id="events-badge">0</span>
          </div>
          <div class="nav-item" data-section="emergency">
            <span class="nav-icon">REC</span>
            <span class="nav-label">Emergency</span>
            <span class="nav-badge emergency-recording-badge" id="emergency-badge" style="display: none;"></span>
          </div>
          <div class="nav-item" data-section="calculator">
            <span class="nav-icon">=</span>
            <span class="nav-label">Calc</span>
          </div>
          <div class="nav-item" data-section="camerabay">
            <span class="nav-icon">@</span>
            <span class="nav-label">Bay</span>
            <span class="nav-badge" id="bay-badge">0</span>
          </div>
          <a href="docs/optimization-providers.html" class="nav-item" style="text-decoration: none; color: inherit;" target="_blank">
            <span class="nav-icon">?</span>
            <span class="nav-label">Docs</span>
          </a>
        </div>
        <div class="sidebar-footer">
          AI VISION
        </div>
      </nav>

      <!-- Content Area -->
      <main class="content-area">
        <!-- ========== IMPORT SECTION ========== -->
        <section class="section active" id="section-import">
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Camera Import</div>
            </div>
            <div class="sub-tabs">
              <div class="sub-tab active" data-subtab="manual">Manual Entry</div>
              <div class="sub-tab" data-subtab="onvif">ONVIF Discovery</div>
              <div class="sub-tab" data-subtab="wave">WAVE VMS</div>
              <div class="sub-tab" data-subtab="csv">CSV Import</div>
            </div>

            <!-- Manual Entry -->
            <div class="sub-content active" id="subtab-manual">
              <div class="panel-body">
                <form id="manual-import-form">
                  <div class="form-section">
                    <div class="section-header">// Camera Details</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Camera ID</label>
                        <input type="text" id="manual-camera-id" placeholder="CAM-001" required />
                      </div>
                      <div class="form-group">
                        <label>IP Address</label>
                        <input type="text" id="manual-camera-ip" placeholder="192.168.1.100" required />
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="manual-camera-location" placeholder="Main Entrance" />
                      </div>
                      <div class="form-group">
                        <label>VMS System</label>
                        <select id="manual-camera-vms">
                          <option value="none">None / Standalone</option>
                          <option value="genetec">Genetec Security Center</option>
                          <option value="milestone">Milestone XProtect</option>
                          <option value="avigilon">Avigilon ACC</option>
                          <option value="exacq">Exacq</option>
                          <option value="hanwha-wave">Hanwha WAVE</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Vendor</label>
                        <input type="text" id="manual-camera-vendor" placeholder="Axis, Hanwha, Hikvision..." />
                      </div>
                      <div class="form-group">
                        <label>Model</label>
                        <input type="text" id="manual-camera-model" placeholder="P3245-V" />
                      </div>
                    </div>
                  </div>
                  <button type="submit" class="btn">+ Add Camera</button>
                </form>
              </div>
            </div>

            <!-- ONVIF Discovery -->
            <div class="sub-content" id="subtab-onvif">
              <div class="panel-body">
                <div class="form-section">
                  <div class="section-header">// Network Discovery</div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Discovery Timeout (seconds)</label>
                      <input type="number" id="onvif-timeout" value="5" min="1" max="30" />
                    </div>
                    <div class="form-group">
                      <label>Max Cameras</label>
                      <input type="number" id="onvif-max" value="50" min="1" max="200" />
                    </div>
                  </div>
                  <button type="button" class="btn" id="onvif-scan-btn">Scan Network</button>
                </div>

                <div class="form-section" id="onvif-results" style="display: none;">
                  <div class="section-header">// Discovered Cameras</div>
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th><input type="checkbox" id="onvif-select-all" /></th>
                        <th>IP Address</th>
                        <th>Vendor</th>
                        <th>Model</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="onvif-table-body">
                    </tbody>
                  </table>
                  <div class="action-bar">
                    <button type="button" class="btn" id="onvif-import-btn">Import Selected</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- WAVE VMS -->
            <div class="sub-content" id="subtab-wave">
              <div class="panel-body">
                <form id="wave-connect-form" autocomplete="off">
                  <div class="form-section">
                    <div class="section-header">// WAVE Server Connection</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="wave-server-ip">Server IP</label>
                        <input type="text" id="wave-server-ip" placeholder="192.168.1.50" autocomplete="off" />
                      </div>
                      <div class="form-group">
                        <label for="wave-port">Port</label>
                        <input type="number" id="wave-port" value="7001" />
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="wave-username">Username</label>
                        <input type="text" id="wave-username" value="admin" autocomplete="username" />
                      </div>
                      <div class="form-group">
                        <label for="wave-password">Password</label>
                        <input type="password" id="wave-password" autocomplete="current-password" />
                      </div>
                    </div>
                    <button type="submit" class="btn" id="wave-connect-btn">Connect to WAVE</button>
                  </div>
                </form>

                <div class="form-section" id="wave-results" style="display: none;">
                  <div class="section-header">// WAVE Cameras</div>
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th><input type="checkbox" id="wave-select-all" /></th>
                        <th>Camera Name</th>
                        <th>IP Address</th>
                        <th>Vendor</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="wave-table-body">
                    </tbody>
                  </table>
                  <div class="action-bar">
                    <button type="button" class="btn" id="wave-import-btn">Import Selected</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- CSV Import -->
            <div class="sub-content" id="subtab-csv">
              <div class="panel-body">
                <div class="form-section">
                  <div class="section-header">// CSV File Upload</div>
                  <div class="upload-zone" id="csv-upload-zone">
                    <div class="upload-icon">CSV</div>
                    <div class="upload-text">Drop CSV file here or click to browse</div>
                    <input type="file" id="csv-file-input" accept=".csv" style="display: none;" />
                  </div>
                  <div style="margin-top: 15px; font-size: 0.75rem; color: var(--text-dim);">
                    Expected columns: id, ip, location, vendor, model, vms_system
                  </div>
                </div>

                <div class="form-section" id="csv-results" style="display: none;">
                  <div class="section-header">// Preview</div>
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Camera ID</th>
                        <th>IP Address</th>
                        <th>Location</th>
                        <th>Vendor</th>
                        <th>Model</th>
                      </tr>
                    </thead>
                    <tbody id="csv-table-body">
                    </tbody>
                  </table>
                  <div class="action-bar">
                    <button type="button" class="btn" id="csv-import-btn">Import All</button>
                    <button type="button" class="btn btn-secondary" id="csv-clear-btn">Clear</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Camera Inventory -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Camera Inventory</div>
              <span class="status-badge">
                <span class="status-dot"></span>
                <span id="inventory-count">0</span> cameras
              </span>
            </div>
            <div class="panel-body">
              <div id="camera-inventory-empty" class="empty-state">
                <div class="empty-state-icon">+</div>
                <div class="empty-state-text">No cameras imported yet</div>
              </div>
              <table class="data-table" id="camera-inventory-table" style="display: none;">
                <thead>
                  <tr>
                    <th>Camera ID</th>
                    <th>IP Address</th>
                    <th>Location</th>
                    <th>Source</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="inventory-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ========== OPTIMIZE SECTION ========== -->
        <section class="section" id="section-optimize">
          <div class="grid-2">
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Camera Configuration</div>
                <div class="status-badge" id="optimize-status-badge">
                  <span class="status-dot"></span>
                  <span id="optimize-status-text">READY</span>
                </div>
              </div>
              <div class="panel-body">
                <form id="optimize-form">
                  <!-- Camera Selection -->
                  <div class="form-section">
                    <div class="section-header">// Select Camera</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Camera</label>
                        <select id="optimize-camera-select">
                          <option value="">-- Select Camera --</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Scene Classification -->
                  <div class="form-section">
                    <div class="section-header">// Scene Classification</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Scene Type</label>
                        <select id="scene-type">
                          <option value="entrance">Entrance / Lobby</option>
                          <option value="hallway">Hallway / Corridor</option>
                          <option value="parking">Parking Lot / Garage</option>
                          <option value="perimeter">Perimeter / Fence Line</option>
                          <option value="interior">Interior / Office</option>
                          <option value="cashwrap">Cashwrap / POS</option>
                          <option value="warehouse">Warehouse / Loading</option>
                          <option value="stairwell">Stairwell / Elevator</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Primary Purpose</label>
                        <select id="purpose">
                          <option value="overview">Overview / General</option>
                          <option value="facial">Facial Recognition</option>
                          <option value="plates">License Plate (LPR)</option>
                          <option value="behavior">Behavior Analysis</option>
                          <option value="counting">People Counting</option>
                          <option value="evidence">Evidence Quality</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- AI Provider Selection -->
                  <div class="form-section">
                    <div class="section-header">// AI Provider</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Optimization Provider</label>
                        <select id="provider-type">
                          <option value="">Auto (Best Available)</option>
                          <option value="claude">Claude AI</option>
                          <option value="gemini">Google Gemini</option>
                          <option value="heuristic">Heuristic (Offline)</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Environmental Factors -->
                  <div class="form-section">
                    <div class="section-header">// Environmental Analysis</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Lighting Conditions</label>
                        <select id="lighting">
                          <option value="constant">Constant Indoor</option>
                          <option value="variable">Variable (WDR Needed)</option>
                          <option value="lowlight">Low-Light / Night</option>
                          <option value="outdoor">Outdoor / Daylight</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Motion Level</label>
                        <select id="motion">
                          <option value="static">Static / Minimal</option>
                          <option value="low">Low Motion</option>
                          <option value="medium">Medium Traffic</option>
                          <option value="high">High Traffic</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Resource Constraints -->
                  <div class="form-section">
                    <div class="section-header">// Resource Constraints</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Bandwidth Limit (Mbps)</label>
                        <input type="number" id="bandwidth" placeholder="4.0" value="4.0" step="0.1" />
                      </div>
                      <div class="form-group">
                        <label>Retention (Days)</label>
                        <input type="number" id="retention" placeholder="30" value="30" />
                      </div>
                    </div>
                  </div>

                  <!-- Sample Frame Upload -->
                  <div class="form-section">
                    <div class="section-header">// Sample Frame (Optional)</div>
                    <div class="upload-zone" id="sample-upload-zone">
                      <div class="upload-icon">IMG</div>
                      <div class="upload-text">Drop camera snapshot or click to browse</div>
                      <input type="file" id="sample-file-input" accept="image/*" style="display: none;" />
                    </div>
                  </div>

                  <button type="submit" class="btn" id="generate-btn">Generate Optimization</button>
                </form>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Optimization Output</div>
              </div>
              <div class="panel-body" style="padding: 0;">
                <div class="output-terminal">
                  <div class="output-content" id="optimize-output">// SELECT A CAMERA AND GENERATE OPTIMIZATION...</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== RESULTS SECTION ========== -->
        <section class="section" id="section-results">
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Optimization Results</div>
              <div class="status-badge">
                <span id="total-optimizations">0</span> optimizations
              </div>
            </div>
            <div class="panel-body">
              <div id="results-empty" class="empty-state">
                <div class="empty-state-icon">#</div>
                <div class="empty-state-text">No optimization results yet</div>
              </div>
              <div id="results-grid" class="card-grid" style="display: none;">
                <!-- Cards populated dynamically -->
              </div>
            </div>
          </div>
        </section>

        <!-- ========== HEALTH SECTION ========== -->
        <section class="section" id="section-health">
          <div class="grid-2">
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Schedule Monitoring</div>
              </div>
              <div class="panel-body">
                <form id="health-schedule-form">
                  <div class="form-section">
                    <div class="section-header">// Select Cameras</div>
                    <div id="health-camera-list">
                      <!-- Checkboxes populated dynamically -->
                    </div>
                  </div>

                  <div class="form-section">
                    <div class="section-header">// Schedule Settings</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Check Interval</label>
                        <select id="health-interval">
                          <option value="hourly">Every Hour</option>
                          <option value="daily" selected>Daily</option>
                          <option value="weekly">Weekly</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Time of Day</label>
                        <input type="time" id="health-time" value="02:00" />
                      </div>
                    </div>
                  </div>

                  <div class="form-section">
                    <div class="section-header">// Drift Detection</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Confidence Threshold</label>
                        <input type="number" id="health-threshold" value="70" min="0" max="100" step="5" />
                        <span style="font-size: 0.7rem; color: var(--text-dim);">Alert if confidence drops below this %</span>
                      </div>
                    </div>
                  </div>

                  <div class="action-bar">
                    <button type="submit" class="btn">Save Schedule</button>
                    <button type="button" class="btn btn-secondary" id="health-check-now-btn">Check Now</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Health Status</div>
              </div>
              <div class="panel-body">
                <div id="health-status-empty" class="empty-state">
                  <div class="empty-state-icon">~</div>
                  <div class="empty-state-text">No health data yet</div>
                </div>
                <div id="health-status-grid" class="card-grid" style="display: none;">
                  <!-- Health cards populated dynamically -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== EVENTS SECTION (MQTT) ========== -->
        <section class="section" id="section-events">
          <!-- MQTT Broker Connection -->
          <div class="panel" style="margin-bottom: 20px;">
            <div class="panel-header">
              <div class="panel-title">MQTT Event Bridge</div>
              <div class="status-badge" id="mqtt-status-badge">
                <span class="status-dot"></span>
                <span id="mqtt-status-text">Disconnected</span>
              </div>
            </div>
            <div class="panel-body">
              <div class="form-section">
                <div class="section-header">// Broker Connection</div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Broker Host</label>
                    <input type="text" id="mqtt-host" placeholder="localhost" value="localhost" />
                  </div>
                  <div class="form-group">
                    <label>Port</label>
                    <input type="number" id="mqtt-port" value="1883" min="1" max="65535" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Username (optional)</label>
                    <input type="text" id="mqtt-username" placeholder="admin" />
                  </div>
                  <div class="form-group">
                    <label>Password (optional)</label>
                    <input type="password" id="mqtt-password" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group" style="flex: none;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                      <input type="checkbox" id="mqtt-use-tls" style="width: auto;" />
                      <span>Use TLS</span>
                    </label>
                  </div>
                </div>
                <div class="action-bar">
                  <button type="button" class="btn" id="mqtt-connect-btn">Connect to Broker</button>
                  <button type="button" class="btn btn-secondary" id="mqtt-disconnect-btn" disabled>Disconnect</button>
                </div>
              </div>

              <!-- Statistics -->
              <div class="form-section" id="mqtt-stats-section" style="display: none; margin-top: 20px;">
                <div class="section-header">// Statistics</div>
                <div class="result-grid" style="grid-template-columns: repeat(4, 1fr);">
                  <div class="result-item">
                    <div class="result-label">Received</div>
                    <div class="result-value" id="mqtt-stat-received">0</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">Processed</div>
                    <div class="result-value" id="mqtt-stat-processed">0</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">Dropped</div>
                    <div class="result-value" id="mqtt-stat-dropped">0</div>
                  </div>
                  <div class="result-item">
                    <div class="result-label">Last Event</div>
                    <div class="result-value" id="mqtt-stat-last-event" style="font-size: 0.9rem;">--</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Camera MQTT Configuration -->
          <div class="panel" style="margin-bottom: 20px;">
            <div class="panel-header">
              <div class="panel-title">Camera Event Configuration</div>
            </div>
            <div class="panel-body">
              <div class="form-section">
                <div class="section-header">// Configure Camera MQTT</div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Camera</label>
                    <select id="mqtt-camera-select">
                      <option value="">-- Select Camera --</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Topic Prefix (optional)</label>
                    <input type="text" id="mqtt-topic-prefix" placeholder="platonicam/{camera_ip}" />
                  </div>
                </div>
                <div class="action-bar">
                  <button type="button" class="btn" id="mqtt-configure-camera-btn" disabled>Configure Camera</button>
                  <button type="button" class="btn btn-secondary" id="mqtt-remove-camera-btn" disabled>Remove Config</button>
                </div>
              </div>

              <!-- Configured Cameras List -->
              <div class="form-section" id="mqtt-cameras-section" style="display: none; margin-top: 20px;">
                <div class="section-header">// Configured Cameras</div>
                <div id="mqtt-cameras-list"></div>
              </div>
            </div>
          </div>

          <!-- Event Log -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">Real-Time Event Log</div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <select id="event-filter-type" style="padding: 4px 8px; font-size: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--orange-dark); color: var(--text-primary);">
                  <option value="">All Events</option>
                  <option value="motion">Motion</option>
                  <option value="line">Line Crossing</option>
                  <option value="intrusion">Intrusion</option>
                  <option value="tamper">Tampering</option>
                  <option value="audio">Audio</option>
                  <option value="face">Face</option>
                </select>
                <button type="button" class="btn btn-secondary btn-sm" id="event-clear-btn">Clear</button>
              </div>
            </div>
            <div class="panel-body" style="padding: 0;">
              <div id="event-log" style="height: 400px; overflow-y: auto; font-size: 0.8rem; background: var(--bg-secondary);">
                <div class="empty-state" id="event-log-empty">
                  <div class="empty-state-icon">!</div>
                  <div class="empty-state-text">No events received</div>
                  <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 10px;">
                    Connect to MQTT broker and configure cameras to see events
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== EMERGENCY RECORD SECTION ========== -->
        <section class="section" id="section-emergency">
          <div class="grid-2">
            <!-- Control Panel -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Emergency Recording</div>
                <div class="status-badge" id="emergency-status-badge">
                  <span class="status-dot"></span>
                  <span id="emergency-status-text">STOPPED</span>
                </div>
              </div>
              <div class="panel-body">
                <div class="form-section">
                  <div class="section-header">// Configuration</div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Capture Interval</label>
                      <select id="emergency-interval">
                        <option value="5">5 seconds</option>
                        <option value="10">10 seconds</option>
                        <option value="30" selected>30 seconds</option>
                        <option value="60">1 minute</option>
                        <option value="300">5 minutes</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Retention</label>
                      <select id="emergency-retention">
                        <option value="1">1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="24" selected>24 hours</option>
                        <option value="72">3 days</option>
                        <option value="168">7 days</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="form-section">
                  <div class="section-header">// Cameras (<span id="emergency-camera-count">0</span> in site)</div>
                  <div id="emergency-camera-list" style="max-height: 200px; overflow-y: auto;">
                    <div class="empty-state" style="padding: 20px;">
                      <div class="empty-state-text">No cameras in current site</div>
                    </div>
                  </div>
                </div>

                <div class="action-bar" style="margin-top: 15px;">
                  <button type="button" class="btn" id="emergency-start-btn">Start Recording</button>
                  <button type="button" class="btn btn-secondary" id="emergency-stop-btn" disabled>Stop</button>
                  <button type="button" class="btn btn-secondary" id="emergency-pause-btn" disabled>Pause</button>
                </div>
              </div>
            </div>

            <!-- Status & Stats Panel -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Recording Status</div>
              </div>
              <div class="panel-body">
                <div class="form-section">
                  <div class="section-header">// Statistics</div>
                  <div class="result-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="result-item" style="background: var(--bg-primary); padding: 15px; border-radius: 4px;">
                      <div style="color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase;">Total Captures</div>
                      <div style="font-size: 1.5rem; color: var(--orange-glow);" id="emergency-stat-captures">0</div>
                    </div>
                    <div class="result-item" style="background: var(--bg-primary); padding: 15px; border-radius: 4px;">
                      <div style="color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase;">Failed</div>
                      <div style="font-size: 1.5rem; color: var(--red-alert);" id="emergency-stat-failed">0</div>
                    </div>
                    <div class="result-item" style="background: var(--bg-primary); padding: 15px; border-radius: 4px;">
                      <div style="color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase;">Storage Used</div>
                      <div style="font-size: 1.5rem; color: var(--text-primary);" id="emergency-stat-storage">0 MB</div>
                    </div>
                    <div class="result-item" style="background: var(--bg-primary); padding: 15px; border-radius: 4px;">
                      <div style="color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase;">Last Capture</div>
                      <div style="font-size: 1rem; color: var(--text-primary);" id="emergency-stat-last">--</div>
                    </div>
                  </div>
                </div>

                <div class="form-section" style="margin-top: 20px;">
                  <div class="section-header">// Camera Status</div>
                  <div id="emergency-camera-status-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
                    <div class="empty-state" style="padding: 20px; grid-column: 1 / -1;">
                      <div class="empty-state-text">Start recording to see camera status</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Snapshots Panel -->
          <div class="panel" style="margin-top: 20px;">
            <div class="panel-header">
              <div class="panel-title">Recent Snapshots</div>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-sm btn-secondary" id="emergency-export-btn" disabled>Export ZIP</button>
                <button class="btn btn-sm btn-secondary" id="emergency-cleanup-btn" disabled>Cleanup Old</button>
              </div>
            </div>
            <div class="panel-body">
              <div id="emergency-snapshots-grid" class="snapshot-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
              </div>
              <div id="emergency-snapshots-empty" class="empty-state" style="padding: 40px;">
                <div class="empty-state-icon">CAM</div>
                <div class="empty-state-text">No snapshots captured yet</div>
                <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 10px;">
                  Start emergency recording to capture snapshots
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== CALCULATOR SECTION ========== -->
        <section class="section" id="section-calculator">
          <div class="grid-2">
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Storage & Bandwidth Calculator</div>
              </div>
              <div class="panel-body">
                <form id="calculator-form">
                  <div class="form-section">
                    <div class="section-header">// Camera Configuration</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Number of Cameras</label>
                        <input type="number" id="calc-cameras" value="8" min="1" max="1000" />
                      </div>
                      <div class="form-group">
                        <label>Resolution</label>
                        <select id="calc-resolution">
                          <option value="2">1080p (2MP)</option>
                          <option value="4">4MP (2K)</option>
                          <option value="5">5MP</option>
                          <option value="8">8MP (4K)</option>
                          <option value="12">12MP</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Frame Rate (FPS)</label>
                        <select id="calc-fps">
                          <option value="10">10 FPS</option>
                          <option value="15" selected>15 FPS (Standard)</option>
                          <option value="20">20 FPS</option>
                          <option value="25">25 FPS</option>
                          <option value="30">30 FPS (Smooth)</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Recording Hours/Day</label>
                        <select id="calc-hours">
                          <option value="8">8 hours (business)</option>
                          <option value="12">12 hours</option>
                          <option value="24" selected>24 hours (continuous)</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="form-section">
                    <div class="section-header">// Compression & Retention</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Codec / Compression</label>
                        <select id="calc-codec">
                          <option value="1.0">H.264 (Standard)</option>
                          <option value="0.5" selected>H.265 (High Efficiency)</option>
                          <option value="0.3">H.265+ / Zipstream (Ultra)</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Retention (Days)</label>
                        <input type="number" id="calc-retention" value="30" min="1" max="365" />
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Scene Activity</label>
                        <select id="calc-activity">
                          <option value="0.6">Low (static scenes)</option>
                          <option value="0.8" selected>Medium (normal traffic)</option>
                          <option value="1.0">High (busy areas)</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="action-bar">
                    <button type="button" class="btn" id="calc-calculate-btn">Calculate</button>
                    <button type="button" class="btn btn-secondary" id="calc-from-site-btn">Use Site Cameras</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <div class="panel-title">Estimates</div>
              </div>
              <div class="panel-body">
                <div id="calc-results" class="empty-state">
                  <div class="empty-state-icon">=</div>
                  <div class="empty-state-text">Configure parameters and click Calculate</div>
                </div>
                <div id="calc-output" style="display: none;">
                  <div class="result-grid">
                    <div class="result-item">
                      <div class="result-label">Per Camera Bitrate</div>
                      <div class="result-value" id="calc-per-camera">-- Mbps</div>
                    </div>
                    <div class="result-item">
                      <div class="result-label">Total Bandwidth</div>
                      <div class="result-value" id="calc-bandwidth">-- Mbps</div>
                    </div>
                    <div class="result-item">
                      <div class="result-label">Daily Storage</div>
                      <div class="result-value" id="calc-daily">-- GB</div>
                    </div>
                    <div class="result-item result-highlight">
                      <div class="result-label">Total Storage Required</div>
                      <div class="result-value result-big" id="calc-total">-- TB</div>
                    </div>
                  </div>
                  <div class="calc-notes" style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--orange-dark); border-radius: 4px;">
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 10px;">// NOTES</div>
                    <ul style="font-size: 0.8rem; color: var(--text-dim); margin: 0; padding-left: 20px;">
                      <li>Add 20% overhead for filesystem and redundancy</li>
                      <li>Smart codecs (H.265+/Zipstream) can reduce storage by 50-70%</li>
                      <li>VBR with motion-based recording can reduce further</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== CAMERA BAY SECTION ========== -->
        <section class="section" id="section-camerabay">
          <div class="panel" style="margin-bottom: 20px;">
            <div class="panel-header">
              <div class="panel-title">Camera Bay</div>
              <div style="font-size: 0.75rem; color: var(--text-dim);">Connected cameras with full details</div>
            </div>
            <div class="panel-body">
              <div id="camera-bay-list">
                <div class="empty-state">
                  <div style="font-size: 3rem; margin-bottom: 10px;">@</div>
                  <div>No cameras connected yet</div>
                  <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 10px;">
                    Go to Import > ONVIF Scan and add cameras with credentials
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Credentials Modal -->
  <div class="modal-overlay" id="credentials-modal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <div class="modal-title">Camera Credentials</div>
        <button class="modal-close" id="credentials-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="credentials-form">
          <div id="credentials-camera-info" style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--orange-dark); border-radius: 4px;">
            <!-- Camera info populated by JS -->
          </div>
          <div class="form-group">
            <label>ONVIF Username</label>
            <input type="text" id="cred-username" placeholder="admin" autocomplete="username" />
          </div>
          <div class="form-group">
            <label>ONVIF Password</label>
            <input type="password" id="cred-password" placeholder="********" autocomplete="current-password" />
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="cred-remember" style="width: auto;" />
              <span>Remember for this session</span>
            </label>
          </div>
          <div id="credentials-status" style="display: none; margin-bottom: 15px; padding: 10px; border-radius: 4px; font-size: 0.85rem;"></div>
          <div class="action-bar">
            <button type="submit" class="btn" id="credentials-connect-btn">Connect & Add</button>
            <button type="button" class="btn btn-secondary" id="credentials-skip-btn">Skip (Add Basic)</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="detail-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Camera Details</div>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- Site Modal -->
  <div class="modal-overlay" id="site-modal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <div class="modal-title" id="site-modal-title">Create New Site</div>
        <button class="modal-close" id="site-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="site-form">
          <div class="form-group">
            <label>Site Name *</label>
            <input type="text" id="site-name-input" class="site-modal-input" placeholder="Main Office Campus" required />
          </div>
          <div class="form-group">
            <label>Description (optional)</label>
            <textarea id="site-description-input" class="site-modal-textarea" placeholder="Building A and B security cameras..."></textarea>
          </div>
          <div class="action-bar">
            <button type="submit" class="btn" id="site-form-submit">Create Site</button>
            <button type="button" class="btn btn-secondary" id="site-form-cancel">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- WebRTC Live View Modal -->
  <div class="modal-overlay" id="liveview-modal">
    <div class="modal" style="max-width: 900px; width: 95%;">
      <div class="modal-header">
        <div class="modal-title">
          <span id="liveview-title">Live View</span>
          <span id="liveview-status" style="margin-left: 15px; font-size: 0.75rem; padding: 3px 8px; border-radius: 3px; background: var(--bg-primary);">Connecting...</span>
        </div>
        <button class="modal-close" id="liveview-close">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0;">
        <!-- Video Container -->
        <div id="liveview-video-container" style="position: relative; background: #000; min-height: 400px; display: flex; align-items: center; justify-content: center;">
          <video id="liveview-video" autoplay playsinline muted style="max-width: 100%; max-height: 500px; display: none;"></video>
          <div id="liveview-placeholder" style="color: var(--text-dim); text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">â–¶</div>
            <div>Establishing WebRTC connection...</div>
            <div id="liveview-connection-status" style="font-size: 0.8rem; margin-top: 10px;"></div>
          </div>
          <!-- RTSP Fallback Message -->
          <div id="liveview-rtsp-fallback" style="display: none; color: var(--text-dim); text-align: center; padding: 20px;">
            <div style="font-size: 2rem; margin-bottom: 15px;">âš </div>
            <div style="margin-bottom: 10px;">Camera does not support native WebRTC</div>
            <div style="font-size: 0.85rem; color: var(--orange-glow);">RTSP URL:</div>
            <code id="liveview-rtsp-url" style="display: block; margin: 10px 0; padding: 10px; background: var(--bg-secondary); border-radius: 4px; word-break: break-all;"></code>
            <div style="font-size: 0.75rem; color: var(--text-dim);">Use VLC or a media server for RTSP-to-WebRTC conversion</div>
          </div>
        </div>
        <!-- Controls -->
        <div style="padding: 15px; background: var(--bg-secondary); border-top: 1px solid var(--border-color);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 10px;">
              <button id="liveview-snapshot-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;" disabled>
                ðŸ“· Snapshot
              </button>
              <button id="liveview-fullscreen-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;" disabled>
                â›¶ Fullscreen
              </button>
            </div>
            <div id="liveview-stats" style="font-size: 0.7rem; color: var(--text-dim);">
              <!-- Stats populated by JS -->
            </div>
          </div>
          <!-- Session Management -->
          <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--bg-primary); display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 0.75rem; color: var(--text-dim);">
              Active Sessions: <span id="webrtc-session-count" style="color: var(--orange-glow);">0</span>
            </div>
            <button id="webrtc-sessions-btn" class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.7rem;">
              Manage Sessions
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- WebRTC Sessions Modal -->
  <div class="modal-overlay" id="webrtc-sessions-modal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <div class="modal-title">WebRTC Sessions</div>
        <button class="modal-close" id="webrtc-sessions-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="webrtc-sessions-list">
          <div class="empty-state" style="padding: 30px;">
            <div class="empty-state-icon" style="font-size: 2rem;">â–¶</div>
            <div class="empty-state-text">No active sessions</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // PlatoniCam - Frontend Application
    // ============================================================

    // ---- Configuration ----
    const API_BASE = (window.location.protocol === 'file:' ||
                      window.location.hostname === 'localhost' ||
                      window.location.hostname === '127.0.0.1' ||
                      window.location.hostname === '')
      ? 'http://localhost:8000'
      : 'https://your-backend-url.com';

    console.log('API Base URL:', API_BASE);

    // ---- State Management ----
    const state = {
      // Site-based structure
      sites: [],
      currentSiteId: null,
      // Transient state (not persisted)
      sampleFrameBase64: null,
      discoveredOnvif: [],
      discoveredWave: [],
      parsedCsv: []
    };

    // ---- UUID Generator ----
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // ---- Site Helper Functions ----
    function getCurrentSite() {
      if (!state.currentSiteId) return null;
      return state.sites.find(s => s.id === state.currentSiteId) || null;
    }

    function getCurrentCameras() {
      const site = getCurrentSite();
      return site ? site.cameras : [];
    }

    function getCurrentOptimizations() {
      const site = getCurrentSite();
      return site ? site.optimizations : [];
    }

    function getCurrentHealthSchedules() {
      const site = getCurrentSite();
      return site ? site.healthSchedules : [];
    }

    function addCameraToCurrentSite(camera) {
      const site = getCurrentSite();
      if (!site) {
        alert('Please create or select a site first');
        return false;
      }
      // Check for duplicate
      if (site.cameras.find(c => c.id === camera.id)) {
        return false;
      }
      site.cameras.push(camera);
      site.updatedAt = new Date().toISOString();
      saveState();
      updateUI();
      return true;
    }

    function addOptimizationToCurrentSite(optimization) {
      const site = getCurrentSite();
      if (!site) return false;
      site.optimizations.push(optimization);
      site.updatedAt = new Date().toISOString();
      saveState();
      updateUI();
      return true;
    }

    function removeCameraFromCurrentSite(idx) {
      const site = getCurrentSite();
      if (!site) return false;
      site.cameras.splice(idx, 1);
      site.updatedAt = new Date().toISOString();
      saveState();
      updateUI();
      return true;
    }

    function updateHealthScheduleInCurrentSite(cameraId, scheduleData) {
      const site = getCurrentSite();
      if (!site) return false;
      const existing = site.healthSchedules.findIndex(s => s.cameraId === cameraId);
      if (existing >= 0) {
        site.healthSchedules[existing] = { ...site.healthSchedules[existing], ...scheduleData };
      } else {
        site.healthSchedules.push(scheduleData);
      }
      site.updatedAt = new Date().toISOString();
      saveState();
      updateUI();
      return true;
    }

    // ---- Site Management Functions ----
    function createSite(name, description = '') {
      const site = {
        id: generateUUID(),
        name: name.trim(),
        description: description.trim(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        cameras: [],
        optimizations: [],
        healthSchedules: []
      };
      state.sites.push(site);
      state.currentSiteId = site.id;
      saveState();
      updateUI();
      return site;
    }

    function switchToSite(siteId) {
      if (!siteId) {
        state.currentSiteId = null;
        saveState();
        updateUI();
        return;
      }
      if (!state.sites.find(s => s.id === siteId)) {
        console.error('Site not found:', siteId);
        return;
      }
      state.currentSiteId = siteId;
      saveState();
      updateUI();
    }

    function deleteSite(siteId) {
      const idx = state.sites.findIndex(s => s.id === siteId);
      if (idx === -1) return;

      const site = state.sites[idx];
      if (!confirm(`Delete site "${site.name}"?\n\nThis will remove ${site.cameras.length} cameras and ${site.optimizations.length} optimizations.`)) {
        return;
      }

      state.sites.splice(idx, 1);

      // If deleted current site, switch to another or null
      if (state.currentSiteId === siteId) {
        state.currentSiteId = state.sites.length > 0 ? state.sites[0].id : null;
      }

      saveState();
      updateUI();
      showToast('Site deleted');
    }

    function exportCurrentSite() {
      const site = getCurrentSite();
      if (!site) {
        alert('No site selected to export');
        return;
      }

      const exportData = {
        version: "1.0",
        exportedAt: new Date().toISOString(),
        site: site
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${site.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast(`Exported: ${site.name}`);
    }

    function importSiteFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);

          // Validate format
          if (!data.site || !data.site.id || !data.site.name) {
            throw new Error('Invalid site file format');
          }

          // Check for version compatibility
          if (data.version && data.version !== "1.0") {
            console.warn('Site file version mismatch, attempting import anyway');
          }

          const importedSite = { ...data.site };

          // Ensure required arrays exist
          importedSite.cameras = importedSite.cameras || [];
          importedSite.optimizations = importedSite.optimizations || [];
          importedSite.healthSchedules = importedSite.healthSchedules || [];

          // Check if site with same ID already exists
          const existingIdx = state.sites.findIndex(s => s.id === importedSite.id);

          if (existingIdx >= 0) {
            if (confirm(`Site "${importedSite.name}" already exists. Replace it?`)) {
              state.sites[existingIdx] = importedSite;
            } else {
              // Create as new site with new ID
              importedSite.id = generateUUID();
              importedSite.name = importedSite.name + ' (imported)';
              importedSite.createdAt = new Date().toISOString();
              importedSite.updatedAt = new Date().toISOString();
              state.sites.push(importedSite);
            }
          } else {
            state.sites.push(importedSite);
          }

          // Switch to imported site
          state.currentSiteId = importedSite.id;
          saveState();
          updateUI();

          showToast(`Imported site: ${importedSite.name} (${importedSite.cameras.length} cameras)`);

        } catch (error) {
          console.error('Import failed:', error);
          alert('Failed to import site: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    function showSiteModal(editMode = false) {
      const modal = document.getElementById('site-modal');
      const title = document.getElementById('site-modal-title');
      const nameInput = document.getElementById('site-name-input');
      const descInput = document.getElementById('site-description-input');
      const submitBtn = document.getElementById('site-form-submit');

      if (editMode && getCurrentSite()) {
        const site = getCurrentSite();
        title.textContent = 'Edit Site';
        nameInput.value = site.name;
        descInput.value = site.description || '';
        submitBtn.textContent = 'Save Changes';
        submitBtn.dataset.mode = 'edit';
      } else {
        title.textContent = 'Create New Site';
        nameInput.value = '';
        descInput.value = '';
        submitBtn.textContent = 'Create Site';
        submitBtn.dataset.mode = 'create';
      }

      modal.classList.add('active');
      nameInput.focus();
    }

    function hideSiteModal() {
      document.getElementById('site-modal').classList.remove('active');
    }

    // Load state from localStorage
    function loadState() {
      try {
        const saved = localStorage.getItem('platonicam_state');
        if (saved) {
          const parsed = JSON.parse(saved);

          // Migration: Check if this is old flat format
          if (parsed.cameras && !parsed.sites) {
            console.log('Migrating from legacy state format...');

            const legacySite = {
              id: generateUUID(),
              name: 'Default Site',
              description: 'Migrated from previous version',
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              cameras: parsed.cameras || [],
              optimizations: parsed.optimizations || [],
              healthSchedules: parsed.healthSchedules || []
            };

            state.sites = [legacySite];
            state.currentSiteId = legacySite.id;

            // Save migrated state
            saveState();
            setTimeout(() => showToast('Data migrated to Sites format'), 500);

          } else {
            // New format
            state.sites = parsed.sites || [];
            state.currentSiteId = parsed.currentSiteId || (state.sites.length > 0 ? state.sites[0].id : null);
          }
        }
      } catch (e) {
        console.error('Failed to load state:', e);
      }
      updateUI();
    }

    // Save state to localStorage
    function saveState() {
      try {
        localStorage.setItem('platonicam_state', JSON.stringify({
          sites: state.sites,
          currentSiteId: state.currentSiteId
        }));
      } catch (e) {
        console.error('Failed to save state:', e);
      }
    }

    // ---- UI Updates ----
    function updateUI() {
      const cameras = getCurrentCameras();
      const optimizations = getCurrentOptimizations();
      const healthSchedules = getCurrentHealthSchedules();

      // Update site selector
      updateSiteSelector();

      // Update site-dependent button states
      const hasSite = !!getCurrentSite();
      document.getElementById('save-site-btn').disabled = !hasSite;
      document.getElementById('delete-site-btn').disabled = !hasSite;

      // Header stats
      document.getElementById('camera-count').textContent = cameras.length;
      document.getElementById('optimized-count').textContent = optimizations.length;
      document.getElementById('results-badge').textContent = optimizations.length;

      // Calculate overall health
      const healthyCount = optimizations.filter(o => o.confidence >= 0.7).length;
      const healthPct = optimizations.length > 0
        ? Math.round((healthyCount / optimizations.length) * 100)
        : '--';
      document.getElementById('health-status').textContent = healthPct === '--' ? '--' : healthPct + '%';

      // Update inventory table
      updateInventoryTable();

      // Update camera selector
      updateCameraSelector();

      // Update results grid
      updateResultsGrid();

      // Update health section
      updateHealthSection();

      // Update camera bay
      updateCameraBay();

      // Update inventory count
      document.getElementById('inventory-count').textContent = cameras.length;
    }

    function updateSiteSelector() {
      const selector = document.getElementById('site-selector');
      const currentValue = state.currentSiteId;

      selector.innerHTML = '<option value="">-- No Site --</option>' +
        state.sites.map(site => `
          <option value="${site.id}"${site.id === currentValue ? ' selected' : ''}>${escapeHtml(site.name)} (${site.cameras.length})</option>
        `).join('');
    }

    function updateInventoryTable() {
      const empty = document.getElementById('camera-inventory-empty');
      const table = document.getElementById('camera-inventory-table');
      const tbody = document.getElementById('inventory-table-body');
      const cameras = getCurrentCameras();
      const hasSite = !!getCurrentSite();

      if (!hasSite) {
        empty.style.display = 'block';
        empty.innerHTML = `
          <div class="empty-state-icon">+</div>
          <div class="empty-state-text">Create or load a site to get started</div>
        `;
        table.style.display = 'none';
        return;
      }

      if (cameras.length === 0) {
        empty.style.display = 'block';
        empty.innerHTML = `
          <div class="empty-state-icon">+</div>
          <div class="empty-state-text">No cameras imported yet</div>
        `;
        table.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      tbody.innerHTML = cameras.map((cam, idx) => `
        <tr>
          <td>${escapeHtml(cam.id)}</td>
          <td>${escapeHtml(cam.ip)}</td>
          <td>${escapeHtml(cam.location || '-')}</td>
          <td>${escapeHtml(cam.source || 'manual')}</td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="removeCamera(${idx})">Remove</button>
          </td>
        </tr>
      `).join('');
    }

    function updateCameraSelector() {
      const select = document.getElementById('optimize-camera-select');
      const currentValue = select.value;
      const cameras = getCurrentCameras();
      const hasSite = !!getCurrentSite();

      if (!hasSite) {
        select.innerHTML = '<option value="">-- Create a site first --</option>';
        return;
      }

      if (cameras.length === 0) {
        select.innerHTML = '<option value="">-- No cameras in site --</option>';
        return;
      }

      select.innerHTML = '<option value="">-- Select Camera --</option>' +
        cameras.map(cam => `
          <option value="${escapeHtml(cam.id)}">${escapeHtml(cam.id)} (${escapeHtml(cam.ip)})</option>
        `).join('');

      // Restore selection if still valid
      if (currentValue && cameras.find(c => c.id === currentValue)) {
        select.value = currentValue;
      }
    }

    function updateResultsGrid() {
      const empty = document.getElementById('results-empty');
      const grid = document.getElementById('results-grid');
      const optimizations = getCurrentOptimizations();
      const cameras = getCurrentCameras();
      const hasSite = !!getCurrentSite();

      document.getElementById('total-optimizations').textContent = optimizations.length;

      if (!hasSite) {
        empty.style.display = 'block';
        empty.innerHTML = `
          <div class="empty-state-icon">#</div>
          <div class="empty-state-text">Create or load a site to view results</div>
        `;
        grid.style.display = 'none';
        return;
      }

      if (optimizations.length === 0) {
        empty.style.display = 'block';
        empty.innerHTML = `
          <div class="empty-state-icon">#</div>
          <div class="empty-state-text">No optimization results yet</div>
        `;
        grid.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      grid.style.display = 'grid';

      // Group by camera, show latest
      const latestByCam = {};
      optimizations.forEach(opt => {
        if (!latestByCam[opt.cameraId] || new Date(opt.timestamp) > new Date(latestByCam[opt.cameraId].timestamp)) {
          latestByCam[opt.cameraId] = opt;
        }
      });

      grid.innerHTML = Object.values(latestByCam).map((opt, idx) => {
        const cam = cameras.find(c => c.id === opt.cameraId) || {};
        const confPct = Math.round(opt.confidence * 100);
        const confClass = confPct >= 80 ? 'confidence-high' : confPct >= 60 ? 'confidence-medium' : 'confidence-low';
        const statusClass = confPct >= 70 ? '' : confPct >= 50 ? 'warning' : 'error';
        const date = new Date(opt.timestamp).toLocaleDateString();

        return `
          <div class="camera-card" onclick="showOptimizationDetail('${escapeHtml(opt.cameraId)}')">
            <div class="camera-card-header">
              <div class="camera-card-id">${escapeHtml(opt.cameraId)}</div>
              <div class="camera-card-status ${statusClass}"></div>
            </div>
            <div class="camera-card-body">
              <div class="camera-card-location">${escapeHtml(cam.location || 'Unknown Location')}</div>
              <div class="camera-card-stats">
                <div class="camera-card-stat">
                  <div class="camera-card-stat-label">Confidence</div>
                  <div class="camera-card-stat-value ${confClass}">${confPct}%</div>
                </div>
                <div class="camera-card-stat">
                  <div class="camera-card-stat-label">Provider</div>
                  <div class="camera-card-stat-value">${opt.aiProvider === 'heuristic' ? 'HEURISTIC' : 'CLAUDE'}</div>
                </div>
                <div class="camera-card-stat">
                  <div class="camera-card-stat-label">Optimized</div>
                  <div class="camera-card-stat-value">${date}</div>
                </div>
                <div class="camera-card-stat">
                  <div class="camera-card-stat-label">Warnings</div>
                  <div class="camera-card-stat-value">${opt.warnings?.length || 0}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateHealthSection() {
      const cameras = getCurrentCameras();
      const healthSchedules = getCurrentHealthSchedules();
      const hasSite = !!getCurrentSite();

      // Update camera checkboxes
      const list = document.getElementById('health-camera-list');
      if (!hasSite) {
        list.innerHTML = '<div style="color: var(--text-dim); font-size: 0.8rem;">Create or load a site first</div>';
      } else if (cameras.length === 0) {
        list.innerHTML = '<div style="color: var(--text-dim); font-size: 0.8rem;">No cameras imported</div>';
      } else {
        list.innerHTML = cameras.map(cam => `
          <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
            <input type="checkbox" class="health-camera-checkbox" value="${escapeHtml(cam.id)}" />
            <span>${escapeHtml(cam.id)} - ${escapeHtml(cam.location || cam.ip)}</span>
          </label>
        `).join('');
      }

      // Update health status grid
      const empty = document.getElementById('health-status-empty');
      const grid = document.getElementById('health-status-grid');

      if (!hasSite || healthSchedules.length === 0) {
        empty.style.display = 'block';
        empty.innerHTML = `
          <div class="empty-state-icon">~</div>
          <div class="empty-state-text">${!hasSite ? 'Create or load a site first' : 'No health data yet'}</div>
        `;
        grid.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      grid.style.display = 'grid';

      grid.innerHTML = healthSchedules.map(schedule => {
        const lastHealth = schedule.lastHealth || {};
        const confPct = lastHealth.confidence ? Math.round(lastHealth.confidence * 100) : '--';
        const confClass = confPct >= 80 ? 'confidence-high' : confPct >= 60 ? 'confidence-medium' : 'confidence-low';

        return `
          <div class="camera-card">
            <div class="camera-card-header">
              <div class="camera-card-id">${escapeHtml(schedule.cameraId)}</div>
              <div class="camera-card-status ${schedule.enabled ? '' : 'warning'}"></div>
            </div>
            <div class="camera-card-body">
              <div class="camera-card-stats">
                <div class="camera-card-stat">
                  <div class="camera-card-stat-label">Health</div>
                  <div class="camera-card-stat-value ${confClass}">${confPct}%</div>
                </div>
                <div class="camera-card-stat">
                  <div class="camera-card-stat-label">Interval</div>
                  <div class="camera-card-stat-value">${schedule.interval}</div>
                </div>
                <div class="camera-card-stat">
                  <div class="camera-card-stat-label">Last Check</div>
                  <div class="camera-card-stat-value">${schedule.lastCheck ? new Date(schedule.lastCheck).toLocaleDateString() : 'Never'}</div>
                </div>
                <div class="camera-card-stat">
                  <div class="camera-card-stat-label">Drift</div>
                  <div class="camera-card-stat-value">${lastHealth.driftDetected ? 'YES' : 'NO'}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ---- Navigation ----
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const section = item.dataset.section;

        // Update nav
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        // Update sections
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-' + section).classList.add('active');
      });
    });

    // Sub-tabs
    document.querySelectorAll('.sub-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const subtab = tab.dataset.subtab;
        const parent = tab.closest('.panel');

        parent.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        parent.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
        document.getElementById('subtab-' + subtab).classList.add('active');
      });
    });

    // ---- Camera Import: Manual ----
    document.getElementById('manual-import-form').addEventListener('submit', (e) => {
      e.preventDefault();

      const camera = {
        id: document.getElementById('manual-camera-id').value.trim(),
        ip: document.getElementById('manual-camera-ip').value.trim(),
        location: document.getElementById('manual-camera-location').value.trim(),
        vmsSystem: document.getElementById('manual-camera-vms').value,
        vendor: document.getElementById('manual-camera-vendor').value.trim(),
        model: document.getElementById('manual-camera-model').value.trim(),
        source: 'manual',
        importedAt: new Date().toISOString()
      };

      if (!camera.id || !camera.ip) {
        alert('Camera ID and IP are required');
        return;
      }

      if (!getCurrentSite()) {
        alert('Please create or select a site first');
        return;
      }

      if (getCurrentCameras().find(c => c.id === camera.id)) {
        alert('Camera with this ID already exists in this site');
        return;
      }

      addCameraToCurrentSite(camera);

      // Clear form
      e.target.reset();
      showToast('Camera added: ' + camera.id);
    });

    // ---- Camera Import: ONVIF ----
    document.getElementById('onvif-scan-btn').addEventListener('click', async () => {
      const btn = document.getElementById('onvif-scan-btn');
      const timeout = document.getElementById('onvif-timeout').value;
      const maxCameras = document.getElementById('onvif-max').value;

      btn.disabled = true;
      btn.textContent = 'Scanning...';

      try {
        const response = await fetch(`${API_BASE}/api/discover?timeout=${timeout}&max_cameras=${maxCameras}`);

        if (!response.ok) {
          throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        state.discoveredOnvif = data.cameras || [];

        if (state.discoveredOnvif.length === 0) {
          alert('No cameras found on network. Make sure:\n- ONVIF cameras are on the same subnet\n- WS-Discovery is not blocked by firewall\n- Cameras have ONVIF enabled');
          document.getElementById('onvif-results').style.display = 'none';
          return;
        }

        // Populate table
        const tbody = document.getElementById('onvif-table-body');
        tbody.innerHTML = state.discoveredOnvif.map((cam, idx) => `
          <tr>
            <td><input type="checkbox" class="onvif-checkbox" data-idx="${idx}" /></td>
            <td>${escapeHtml(cam.ip || cam.address || '-')}</td>
            <td>${escapeHtml(cam.vendor || cam.manufacturer || '-')}</td>
            <td>${escapeHtml(cam.model || '-')}</td>
            <td class="status-online">Online</td>
          </tr>
        `).join('');

        document.getElementById('onvif-results').style.display = 'block';

      } catch (error) {
        console.error('ONVIF discovery error:', error);
        if (error.message === 'Failed to fetch') {
          alert('Cannot connect to backend server.\n\nMake sure the backend is running:\n  cd backend\n  start.bat\n\nBackend should be at: ' + API_BASE);
        } else {
          alert('Discovery failed: ' + error.message);
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Scan Network';
      }
    });

    document.getElementById('onvif-select-all').addEventListener('change', (e) => {
      document.querySelectorAll('.onvif-checkbox').forEach(cb => cb.checked = e.target.checked);
    });

    // Queue for adding cameras with credentials
    let cameraAddQueue = [];
    let processingQueue = false;

    document.getElementById('onvif-import-btn').addEventListener('click', () => {
      const selected = [];
      document.querySelectorAll('.onvif-checkbox:checked').forEach(cb => {
        const idx = parseInt(cb.dataset.idx);
        selected.push(state.discoveredOnvif[idx]);
      });

      if (selected.length === 0) {
        alert('No cameras selected');
        return;
      }

      if (!getCurrentSite()) {
        alert('Please create or select a site first');
        return;
      }

      // Filter out already-added cameras
      const toAdd = selected.filter(cam => {
        const id = 'CAM-' + (cam.ip || '').replace(/\./g, '-');
        return !getCurrentCameras().find(c => c.id === id);
      });

      if (toAdd.length === 0) {
        showToast('All selected cameras already added');
        return;
      }

      // Queue cameras for credential entry
      cameraAddQueue = toAdd.map(cam => ({
        id: 'CAM-' + (cam.ip || '').replace(/\./g, '-'),
        ip: cam.ip || cam.address || '',
        port: cam.port || 80,
        vendor: cam.vendor || cam.manufacturer || '',
        model: cam.model || '',
        mac: cam.mac || ''
      }));

      // Start processing queue - show modal for first camera
      document.getElementById('onvif-results').style.display = 'none';
      processNextCamera();
    });

    function processNextCamera() {
      if (cameraAddQueue.length === 0) {
        showToast('All cameras processed');
        updateCameraBay();
        return;
      }

      const camera = cameraAddQueue.shift();
      showCredentialsModal(camera);

      // Update modal title to show progress if multiple cameras
      if (cameraAddQueue.length > 0) {
        document.querySelector('#credentials-modal .modal-title').textContent =
          `Camera Credentials (${cameraAddQueue.length + 1} remaining)`;
      } else {
        document.querySelector('#credentials-modal .modal-title').textContent = 'Camera Credentials';
      }
    }

    // ---- Camera Import: WAVE ----
    document.getElementById('wave-connect-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('wave-connect-btn');
      const serverIp = document.getElementById('wave-server-ip').value.trim();
      const port = document.getElementById('wave-port').value;
      const username = document.getElementById('wave-username').value;
      const password = document.getElementById('wave-password').value;

      if (!serverIp) {
        alert('Server IP is required');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Connecting...';

      try {
        const response = await fetch(
          `${API_BASE}/api/wave/discover?server_ip=${serverIp}&port=${port}&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
        );
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        state.discoveredWave = data.cameras || [];

        if (state.discoveredWave.length === 0) {
          alert('No cameras found in WAVE system');
          document.getElementById('wave-results').style.display = 'none';
          return;
        }

        // Populate table
        const tbody = document.getElementById('wave-table-body');
        tbody.innerHTML = state.discoveredWave.map((cam, idx) => `
          <tr>
            <td><input type="checkbox" class="wave-checkbox" data-idx="${idx}" /></td>
            <td>${escapeHtml(cam.name || cam.id || '-')}</td>
            <td>${escapeHtml(cam.ip || '-')}</td>
            <td>${escapeHtml(cam.vendor || '-')}</td>
            <td class="${cam.status === 'Online' ? 'status-online' : 'status-offline'}">${cam.status || 'Unknown'}</td>
          </tr>
        `).join('');

        document.getElementById('wave-results').style.display = 'block';

      } catch (error) {
        console.error('WAVE discovery error:', error);
        if (error.message === 'Failed to fetch') {
          alert('Cannot connect to backend server.\n\nMake sure the backend is running:\n  cd backend\n  start.bat\n\nBackend should be at: ' + API_BASE);
        } else {
          alert('Connection failed: ' + error.message);
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Connect to WAVE';
      }
    });

    document.getElementById('wave-select-all').addEventListener('change', (e) => {
      document.querySelectorAll('.wave-checkbox').forEach(cb => cb.checked = e.target.checked);
    });

    document.getElementById('wave-import-btn').addEventListener('click', () => {
      const selected = [];
      document.querySelectorAll('.wave-checkbox:checked').forEach(cb => {
        const idx = parseInt(cb.dataset.idx);
        selected.push(state.discoveredWave[idx]);
      });

      if (selected.length === 0) {
        alert('No cameras selected');
        return;
      }

      if (!getCurrentSite()) {
        alert('Please create or select a site first');
        return;
      }

      let imported = 0;
      selected.forEach(cam => {
        const id = cam.id || 'CAM-WAVE-' + Date.now();
        if (!getCurrentCameras().find(c => c.id === id)) {
          const camera = {
            id: id,
            ip: cam.ip || '',
            location: cam.name || '',
            vendor: cam.vendor || '',
            model: cam.model || '',
            vmsSystem: 'hanwha-wave',
            vmsCameraId: cam.id,
            source: 'wave',
            importedAt: new Date().toISOString()
          };
          if (addCameraToCurrentSite(camera)) {
            imported++;
          }
        }
      });

      showToast(`Imported ${imported} cameras`);
      document.getElementById('wave-results').style.display = 'none';
    });

    // ---- Camera Import: CSV ----
    const csvUploadZone = document.getElementById('csv-upload-zone');
    const csvFileInput = document.getElementById('csv-file-input');

    csvUploadZone.addEventListener('click', () => csvFileInput.click());
    csvUploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      csvUploadZone.style.borderColor = 'var(--orange-primary)';
    });
    csvUploadZone.addEventListener('dragleave', () => {
      csvUploadZone.style.borderColor = 'var(--orange-dark)';
    });
    csvUploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      csvUploadZone.style.borderColor = 'var(--orange-dark)';
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.csv')) {
        handleCsvUpload(file);
      }
    });
    csvFileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) {
        handleCsvUpload(e.target.files[0]);
      }
    });

    function handleCsvUpload(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(l => l.trim());

        if (lines.length < 2) {
          alert('CSV file must have header row and at least one data row');
          return;
        }

        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        state.parsedCsv = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim());
          const row = {};
          headers.forEach((h, idx) => row[h] = values[idx] || '');

          state.parsedCsv.push({
            id: row.id || row.camera_id || 'CAM-' + i,
            ip: row.ip || row.ip_address || '',
            location: row.location || '',
            vendor: row.vendor || row.manufacturer || '',
            model: row.model || '',
            vmsSystem: row.vms_system || row.vms || 'none'
          });
        }

        // Display preview
        const tbody = document.getElementById('csv-table-body');
        tbody.innerHTML = state.parsedCsv.map(cam => `
          <tr>
            <td>${escapeHtml(cam.id)}</td>
            <td>${escapeHtml(cam.ip)}</td>
            <td>${escapeHtml(cam.location)}</td>
            <td>${escapeHtml(cam.vendor)}</td>
            <td>${escapeHtml(cam.model)}</td>
          </tr>
        `).join('');

        document.getElementById('csv-results').style.display = 'block';
        csvUploadZone.innerHTML = `
          <div class="upload-icon">CSV</div>
          <div class="upload-text">Loaded: ${file.name}</div>
          <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 8px;">${state.parsedCsv.length} cameras</div>
        `;
      };
      reader.readAsText(file);
    }

    document.getElementById('csv-import-btn').addEventListener('click', () => {
      if (state.parsedCsv.length === 0) {
        alert('No CSV data to import');
        return;
      }

      if (!getCurrentSite()) {
        alert('Please create or select a site first');
        return;
      }

      let imported = 0;
      state.parsedCsv.forEach(cam => {
        if (!getCurrentCameras().find(c => c.id === cam.id)) {
          const camera = {
            ...cam,
            source: 'csv',
            importedAt: new Date().toISOString()
          };
          if (addCameraToCurrentSite(camera)) {
            imported++;
          }
        }
      });

      showToast(`Imported ${imported} cameras`);

      // Clear
      state.parsedCsv = [];
      document.getElementById('csv-results').style.display = 'none';
      csvUploadZone.innerHTML = `
        <div class="upload-icon">CSV</div>
        <div class="upload-text">Drop CSV file here or click to browse</div>
      `;
    });

    document.getElementById('csv-clear-btn').addEventListener('click', () => {
      state.parsedCsv = [];
      document.getElementById('csv-results').style.display = 'none';
      csvUploadZone.innerHTML = `
        <div class="upload-icon">CSV</div>
        <div class="upload-text">Drop CSV file here or click to browse</div>
      `;
    });

    // ---- Remove Camera ----
    function removeCamera(idx) {
      if (confirm('Remove this camera from inventory?')) {
        removeCameraFromCurrentSite(idx);
        updateUI();
      }
    }

    // ---- Camera Bay & Credentials ----
    let pendingCameraAdd = null;  // Camera being added via credentials modal
    const sessionCredentials = {};  // Cached credentials for session

    // Credentials modal elements
    const credentialsModal = document.getElementById('credentials-modal');
    const credentialsForm = document.getElementById('credentials-form');
    const credentialsStatus = document.getElementById('credentials-status');
    const credentialsCameraInfo = document.getElementById('credentials-camera-info');

    document.getElementById('credentials-modal-close').addEventListener('click', () => {
      credentialsModal.classList.remove('active');
      pendingCameraAdd = null;
    });

    credentialsModal.addEventListener('click', (e) => {
      if (e.target === credentialsModal) {
        credentialsModal.classList.remove('active');
        pendingCameraAdd = null;
      }
    });

    document.getElementById('credentials-skip-btn').addEventListener('click', () => {
      // Add camera without connecting (basic info only)
      if (pendingCameraAdd) {
        const camera = {
          id: pendingCameraAdd.id || `CAM-${pendingCameraAdd.ip.replace(/\./g, '-')}`,
          ip: pendingCameraAdd.ip,
          port: pendingCameraAdd.port || 80,
          vendor: pendingCameraAdd.vendor || pendingCameraAdd.manufacturer || '',
          model: pendingCameraAdd.model || '',
          source: 'onvif',
          importedAt: new Date().toISOString(),
          connected: false
        };
        if (addCameraToCurrentSite(camera)) {
          showToast(`Added camera: ${camera.ip} (basic)`);
        }
        credentialsModal.classList.remove('active');
        pendingCameraAdd = null;
      }
    });

    credentialsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!pendingCameraAdd) return;

      const username = document.getElementById('cred-username').value.trim();
      const password = document.getElementById('cred-password').value;
      const remember = document.getElementById('cred-remember').checked;

      if (!username || !password) {
        showCredentialsStatus('error', 'Username and password required');
        return;
      }

      const btn = document.getElementById('credentials-connect-btn');
      btn.disabled = true;
      btn.textContent = 'Connecting...';
      showCredentialsStatus('info', 'Connecting to camera...');

      try {
        const response = await fetch(`${API_BASE}/api/camera/connect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ip: pendingCameraAdd.ip,
            port: pendingCameraAdd.port || 80,
            username: username,
            password: password
          })
        });

        const result = await response.json();

        if (result.connected || result.capabilities) {
          // Success - build full camera object
          const camera = {
            id: pendingCameraAdd.id || `CAM-${pendingCameraAdd.ip.replace(/\./g, '-')}`,
            ip: pendingCameraAdd.ip,
            port: pendingCameraAdd.port || 80,
            vendor: result.deviceInfo?.vendor || pendingCameraAdd.vendor || '',
            model: result.deviceInfo?.model || pendingCameraAdd.model || '',
            firmware: result.deviceInfo?.firmware || '',
            serialNumber: result.deviceInfo?.serialNumber || '',
            source: 'onvif',
            importedAt: new Date().toISOString(),
            connected: true,
            capabilities: result.capabilities,
            currentSettings: result.currentSettings,
            snapshot: result.snapshot,
            snapshotMediaType: result.snapshotMediaType,
            profiles: result.profiles
          };

          // Store credentials on camera object if remember is checked (persists with site data)
          if (remember) {
            camera.username = username;
            camera.password = password;
            sessionCredentials[pendingCameraAdd.ip] = { username, password };
          } else {
            // Still cache for current session even if not persisting
            sessionCredentials[pendingCameraAdd.ip] = { username, password };
          }

          if (addCameraToCurrentSite(camera)) {
            showToast(`Connected & added: ${camera.ip}`);
            updateCameraBay();
          }

          credentialsModal.classList.remove('active');
          pendingCameraAdd = null;
        } else {
          // Partial failure
          const errors = result.errors?.join(', ') || 'Connection failed';
          showCredentialsStatus('error', errors);
        }

      } catch (error) {
        console.error('Connect error:', error);
        showCredentialsStatus('error', `Connection failed: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Connect & Add';
      }
    });

    function showCredentialsStatus(type, message) {
      credentialsStatus.style.display = 'block';
      credentialsStatus.textContent = message;
      if (type === 'error') {
        credentialsStatus.style.background = 'rgba(255, 50, 50, 0.2)';
        credentialsStatus.style.border = '1px solid #ff5050';
        credentialsStatus.style.color = '#ff5050';
      } else if (type === 'success') {
        credentialsStatus.style.background = 'rgba(0, 255, 65, 0.2)';
        credentialsStatus.style.border = '1px solid #00ff41';
        credentialsStatus.style.color = '#00ff41';
      } else {
        credentialsStatus.style.background = 'rgba(255, 107, 26, 0.2)';
        credentialsStatus.style.border = '1px solid var(--orange-primary)';
        credentialsStatus.style.color = 'var(--orange-primary)';
      }
    }

    function showCredentialsModal(camera) {
      pendingCameraAdd = camera;

      // Pre-fill with cached credentials if available
      const cached = sessionCredentials[camera.ip];
      document.getElementById('cred-username').value = cached?.username || 'admin';
      document.getElementById('cred-password').value = cached?.password || '';
      document.getElementById('cred-remember').checked = !!cached;

      // Show camera info
      credentialsCameraInfo.innerHTML = `
        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 8px; font-size: 0.85rem;">
          <span style="color: var(--text-dim);">IP:</span>
          <span style="color: var(--orange-glow);">${escapeHtml(camera.ip)}</span>
          <span style="color: var(--text-dim);">Vendor:</span>
          <span>${escapeHtml(camera.vendor || camera.manufacturer || 'Unknown')}</span>
          <span style="color: var(--text-dim);">Model:</span>
          <span>${escapeHtml(camera.model || 'Unknown')}</span>
        </div>
      `;

      credentialsStatus.style.display = 'none';
      credentialsModal.classList.add('active');
    }

    // Continue processing camera queue after skip
    document.getElementById('credentials-skip-btn').addEventListener('click', () => {
      setTimeout(processNextCamera, 100);
    });

    // Continue processing camera queue after successful connect
    credentialsForm.addEventListener('submit', () => {
      const checkAndContinue = setInterval(() => {
        if (!credentialsModal.classList.contains('active')) {
          clearInterval(checkAndContinue);
          setTimeout(processNextCamera, 200);
        }
      }, 100);
      setTimeout(() => clearInterval(checkAndContinue), 30000);
    });

    // Camera Bay display
    function updateCameraBay() {
      const cameras = getCurrentCameras().filter(c => c.connected);
      const bayList = document.getElementById('camera-bay-list');
      const bayBadge = document.getElementById('bay-badge');

      bayBadge.textContent = cameras.length;

      if (cameras.length === 0) {
        bayList.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 3rem; margin-bottom: 10px;">@</div>
            <div>No cameras connected yet</div>
            <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 10px;">
              Go to Import > ONVIF Scan and add cameras with credentials
            </div>
          </div>
        `;
        return;
      }

      bayList.innerHTML = cameras.map((cam, idx) => `
        <div class="camera-bay-card" style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; padding: 20px; margin-bottom: 15px; background: var(--bg-secondary); border: 1px solid var(--orange-dark); border-radius: 4px;">
          <!-- Snapshot -->
          <div class="camera-bay-snapshot" style="position: relative;">
            ${cam.snapshot ? `
              <img src="${cam.snapshot}" alt="Camera snapshot" style="width: 100%; border-radius: 4px; border: 1px solid var(--border-color);" />
            ` : `
              <div style="width: 100%; height: 120px; background: var(--bg-primary); border: 1px dashed var(--border-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-dim);">
                No snapshot
              </div>
            `}
            <button onclick="refreshCameraSnapshot('${cam.ip}')" class="btn btn-secondary" style="position: absolute; bottom: 5px; right: 5px; padding: 4px 8px; font-size: 0.7rem;">
              Refresh
            </button>
          </div>

          <!-- Details -->
          <div class="camera-bay-details">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
              <div>
                <div style="font-size: 1.1rem; color: var(--orange-glow); font-weight: 600;">${escapeHtml(cam.ip)}</div>
                <div style="font-size: 0.85rem; color: var(--text-dim);">${escapeHtml(cam.vendor || '')} ${escapeHtml(cam.model || '')}</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="openLiveView('${cam.ip}')" class="btn" style="padding: 6px 12px; font-size: 0.75rem; background: var(--terminal-green); color: #000;">â–¶ Live</button>
                <button onclick="selectCameraForOptimize('${cam.id}')" class="btn" style="padding: 6px 12px; font-size: 0.75rem;">Optimize</button>
                <button onclick="viewCameraDetails('${cam.id}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;">Details</button>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <!-- Device Info -->
              <div>
                <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 8px;">// DEVICE</div>
                <div style="font-size: 0.8rem; display: grid; gap: 4px;">
                  <div><span style="color: var(--text-dim);">Firmware:</span> ${escapeHtml(cam.firmware || 'N/A')}</div>
                  <div><span style="color: var(--text-dim);">Serial:</span> ${escapeHtml(cam.serialNumber || 'N/A')}</div>
                </div>
              </div>

              <!-- Capabilities -->
              <div>
                <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 8px;">// CAPABILITIES</div>
                <div style="font-size: 0.8rem; display: grid; gap: 4px;">
                  ${cam.capabilities ? `
                    <div><span style="color: var(--text-dim);">Res:</span> ${escapeHtml((cam.capabilities.resolutions || cam.capabilities.supportedResolutions || []).slice(0, 2).join(', ') || 'N/A')}</div>
                    <div><span style="color: var(--text-dim);">Codecs:</span> ${escapeHtml((cam.capabilities.codecs || cam.capabilities.supportedCodecs || []).join(', ') || 'N/A')}</div>
                    <div><span style="color: var(--text-dim);">Max FPS:</span> ${cam.capabilities.maxFps || 'N/A'}</div>
                  ` : '<div style="color: var(--text-dim);">Not queried</div>'}
                </div>
              </div>

              <!-- Current Settings -->
              <div>
                <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 8px;">// CURRENT</div>
                <div style="font-size: 0.8rem; display: grid; gap: 4px;">
                  ${cam.currentSettings?.stream ? `
                    <div><span style="color: var(--text-dim);">Res:</span> ${escapeHtml(cam.currentSettings.stream.resolution || 'N/A')}</div>
                    <div><span style="color: var(--text-dim);">Codec:</span> ${escapeHtml(cam.currentSettings.stream.codec || 'N/A')}</div>
                    <div><span style="color: var(--text-dim);">FPS:</span> ${cam.currentSettings.stream.fps || 'N/A'}</div>
                  ` : '<div style="color: var(--text-dim);">Not queried</div>'}
                </div>
              </div>

              <!-- Security/TLS -->
              <div>
                <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 8px;">// SECURITY</div>
                <div style="font-size: 0.8rem; display: grid; gap: 4px;">
                  ${cam.tlsInfo ? `
                    <div>
                      <span style="color: var(--text-dim);">TLS:</span>
                      ${cam.tlsInfo.valid ?
                        (cam.tlsInfo.self_signed ?
                          '<span class="tls-warning">Self-signed</span>' :
                          '<span class="tls-valid">Valid</span>') :
                        '<span class="tls-invalid">Invalid</span>'}
                    </div>
                    ${cam.tlsInfo.issuer ? `<div><span style="color: var(--text-dim);">Issuer:</span> ${escapeHtml(cam.tlsInfo.issuer)}</div>` : ''}
                    ${cam.tlsInfo.days_until_expiry !== null ? `<div><span style="color: var(--text-dim);">Expires:</span> ${cam.tlsInfo.days_until_expiry}d</div>` : ''}
                  ` : '<div style="color: var(--text-dim);">Not checked</div>'}
                  <div style="margin-top: 4px;">
                    <span style="color: var(--text-dim);">Discovery:</span>
                    ${cam.discoveryMode === true ? '<span class="tls-warning">Enabled</span>' :
                      cam.discoveryMode === false ? '<span class="tls-valid">Disabled</span>' :
                      '<span style="color: var(--text-dim);">Unknown</span>'}
                  </div>
                </div>
                <div style="display: flex; gap: 4px; margin-top: 8px;">
                  <button onclick="checkCameraTls('${cam.ip}')" class="btn btn-secondary" style="padding: 3px 6px; font-size: 0.65rem;">Check TLS</button>
                  <button onclick="toggleDiscoveryMode('${cam.ip}')" class="btn btn-secondary" style="padding: 3px 6px; font-size: 0.65rem;">Toggle Disc</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function refreshCameraSnapshot(cameraIp) {
      const cam = getCurrentCameras().find(c => c.ip === cameraIp);
      if (!cam) return;

      const creds = sessionCredentials[cameraIp];
      if (!creds) {
        showToast('No credentials cached. Re-add camera with credentials.');
        return;
      }

      showToast('Refreshing snapshot...');

      try {
        const response = await fetch(`${API_BASE}/api/camera/${cameraIp}/snapshot?username=${encodeURIComponent(creds.username)}&password=${encodeURIComponent(creds.password)}&port=${cam.port || 80}`, {
          method: 'POST'
        });
        const result = await response.json();

        if (result.snapshot) {
          cam.snapshot = result.snapshot;
          cam.snapshotMediaType = result.mediaType;
          saveState();
          updateCameraBay();
          showToast('Snapshot refreshed');
        } else {
          showToast('Failed to get snapshot');
        }
      } catch (error) {
        console.error('Snapshot refresh error:', error);
        showToast('Snapshot refresh failed');
      }
    }

    function selectCameraForOptimize(cameraId) {
      const cam = getCurrentCameras().find(c => c.id === cameraId);
      if (!cam) return;

      // Switch to optimize section
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      document.querySelector('[data-section="optimize"]').classList.add('active');
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('section-optimize').classList.add('active');

      // Select camera in dropdown
      const select = document.getElementById('optimize-camera-select');
      for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].value === cameraId) {
          select.selectedIndex = i;
          break;
        }
      }

      // Pre-fill sample frame if camera has snapshot
      if (cam.snapshot) {
        state.sampleFrameBase64 = cam.snapshot;
        const uploadZone = document.getElementById('sample-upload-zone');
        if (uploadZone) {
          uploadZone.innerHTML = `
            <img src="${cam.snapshot}" style="max-width:100%; max-height:150px; border-radius:4px; margin-bottom:8px;" />
            <div style="font-size:0.75rem; color:var(--text-dim);">Auto-loaded from camera snapshot</div>
          `;
        }
      }
    }

    function viewCameraDetails(cameraId) {
      const cam = getCurrentCameras().find(c => c.id === cameraId);
      if (!cam) return;

      document.getElementById('modal-title').textContent = `Camera: ${cam.ip}`;
      document.getElementById('modal-body').innerHTML = `
        <div style="display: grid; gap: 20px;">
          ${cam.snapshot ? `
            <div>
              <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 8px;">// SNAPSHOT</div>
              <img src="${cam.snapshot}" style="max-width: 100%; border-radius: 4px;" />
            </div>
          ` : ''}

          <div>
            <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 8px;">// DEVICE INFO</div>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px; font-size: 0.85rem;">
              <span style="color: var(--text-dim);">IP:</span><span>${escapeHtml(cam.ip)}</span>
              <span style="color: var(--text-dim);">Port:</span><span>${cam.port || 80}</span>
              <span style="color: var(--text-dim);">Vendor:</span><span>${escapeHtml(cam.vendor || 'Unknown')}</span>
              <span style="color: var(--text-dim);">Model:</span><span>${escapeHtml(cam.model || 'Unknown')}</span>
              <span style="color: var(--text-dim);">Firmware:</span><span>${escapeHtml(cam.firmware || 'N/A')}</span>
              <span style="color: var(--text-dim);">Serial:</span><span>${escapeHtml(cam.serialNumber || 'N/A')}</span>
            </div>
          </div>

          ${cam.capabilities ? `
            <div>
              <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 8px;">// CAPABILITIES</div>
              ${formatCapabilities(cam.capabilities)}
            </div>
          ` : ''}

          ${cam.currentSettings ? `
            <div>
              <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 8px;">// CURRENT SETTINGS</div>
              ${formatCurrentSettingsForBay(cam.currentSettings)}
            </div>
          ` : ''}
        </div>
      `;
      document.getElementById('detail-modal').classList.add('active');
    }

    // ---- Optimization ----
    const sampleUploadZone = document.getElementById('sample-upload-zone');
    const sampleFileInput = document.getElementById('sample-file-input');

    sampleUploadZone.addEventListener('click', () => sampleFileInput.click());
    sampleUploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      sampleUploadZone.style.borderColor = 'var(--orange-primary)';
    });
    sampleUploadZone.addEventListener('dragleave', () => {
      sampleUploadZone.style.borderColor = 'var(--orange-dark)';
    });
    sampleUploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      sampleUploadZone.style.borderColor = 'var(--orange-dark)';
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleSampleUpload(file);
      }
    });
    sampleFileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) {
        handleSampleUpload(e.target.files[0]);
      }
    });

    function handleSampleUpload(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        state.sampleFrameBase64 = e.target.result;
        sampleUploadZone.innerHTML = `
          <div class="upload-icon">IMG</div>
          <div class="upload-text">Loaded: ${file.name}</div>
          <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 8px;">${(file.size / 1024).toFixed(1)} KB</div>
        `;
      };
      reader.readAsDataURL(file);
    }

    function setOptimizeStatus(mode, message) {
      const badge = document.getElementById('optimize-status-badge');
      const text = document.getElementById('optimize-status-text');
      badge.className = 'status-badge ' + mode;
      text.textContent = message;
    }

    // Auto-fill snapshot when camera is selected from dropdown
    document.getElementById('optimize-camera-select').addEventListener('change', (e) => {
      const cameraId = e.target.value;
      if (!cameraId) {
        // Clear sample frame when no camera selected
        state.sampleFrameBase64 = null;
        document.getElementById('sample-upload-zone').innerHTML = `
          <div class="upload-icon">IMG</div>
          <div class="upload-text">Drop camera snapshot or click to browse</div>
          <input type="file" id="sample-file-input" accept="image/*" style="display: none;" />
        `;
        return;
      }

      const cam = getCurrentCameras().find(c => c.id === cameraId);
      if (cam && cam.snapshot) {
        state.sampleFrameBase64 = cam.snapshot;
        document.getElementById('sample-upload-zone').innerHTML = `
          <img src="${cam.snapshot}" style="max-width:100%; max-height:150px; border-radius:4px; margin-bottom:8px;" />
          <div style="font-size:0.75rem; color:var(--text-dim);">Auto-loaded from camera snapshot</div>
        `;
      } else {
        // Camera has no snapshot - show upload zone
        state.sampleFrameBase64 = null;
        document.getElementById('sample-upload-zone').innerHTML = `
          <div class="upload-icon">IMG</div>
          <div class="upload-text">Drop camera snapshot or click to browse</div>
          <input type="file" id="sample-file-input" accept="image/*" style="display: none;" />
        `;
      }
    });

    document.getElementById('optimize-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const cameraId = document.getElementById('optimize-camera-select').value;
      if (!cameraId) {
        alert('Please select a camera');
        return;
      }

      const camera = getCurrentCameras().find(c => c.id === cameraId);
      if (!camera) {
        alert('Camera not found');
        return;
      }

      setOptimizeStatus('loading', 'PROCESSING...');
      document.getElementById('generate-btn').disabled = true;

      try {
        const request = {
          camera: {
            id: camera.id,
            ip: camera.ip,
            location: camera.location,
            vmsSystem: camera.vmsSystem || 'none',
            sceneType: document.getElementById('scene-type').value,
            purpose: document.getElementById('purpose').value,
            vendor: camera.vendor || 'Generic',
            model: camera.model || 'Unknown'
          },
          capabilities: {
            maxResolution: "3840x2160",
            supportedCodecs: ["H.264", "H.265"],
            maxFps: 30,
            wdrLevels: ["Off", "Low", "Medium", "High"],
            irModes: ["Off", "Auto", "On"],
            hasLPRMode: false
          },
          currentSettings: {
            stream: { resolution: "1920x1080", codec: "H.264", fps: 30, bitrateMbps: 6.0 },
            exposure: { shutter: "1/30", wdr: "Off" },
            lowLight: { irMode: "Auto" }
          },
          context: {
            bandwidthLimitMbps: parseFloat(document.getElementById('bandwidth').value),
            targetRetentionDays: parseInt(document.getElementById('retention').value),
            notes: `Lighting: ${document.getElementById('lighting').value}, Motion: ${document.getElementById('motion').value}`,
            sampleFrame: state.sampleFrameBase64
          },
          providerType: document.getElementById('provider-type').value || null
        };

        const response = await fetch(`${API_BASE}/api/optimize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(request)
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        const result = await response.json();

        // Store optimization result
        addOptimizationToCurrentSite({
          cameraId: camera.id,
          timestamp: result.generatedAt || new Date().toISOString(),
          confidence: result.confidence,
          aiProvider: result.aiProvider,
          settings: result.recommendedSettings,
          explanation: result.explanation,
          warnings: result.warnings || []
        });
        updateUI();

        // Display result
        displayOptimizationResult(result);
        setOptimizeStatus('success', 'COMPLETE');

      } catch (error) {
        console.error('Optimization error:', error);
        document.getElementById('optimize-output').textContent =
          `// ERROR: ${error.message}\n\n` +
          `// Check that backend is running at: ${API_BASE}`;
        setOptimizeStatus('error', 'ERROR');
      } finally {
        document.getElementById('generate-btn').disabled = false;
      }
    });

    // Settings category definitions for organized display
    const SETTINGS_CATEGORIES = {
      stream: {
        label: 'Stream Configuration',
        icon: '[>]',
        fields: {
          resolution: 'Resolution',
          codec: 'Codec',
          fps: 'Frame Rate',
          bitrateMbps: 'Bitrate (Mbps)',
          bitrateMode: 'Bitrate Mode',
          gopSize: 'GOP Size',
          keyframeInterval: 'Keyframe Interval',
          profile: 'Profile',
          quality: 'Quality'
        }
      },
      exposure: {
        label: 'Exposure Control',
        icon: '[O]',
        fields: {
          mode: 'Mode',
          shutter: 'Shutter Speed',
          shutterSpeed: 'Shutter Speed',
          iris: 'Iris',
          irisMode: 'Iris Mode',
          gain: 'Gain',
          gainLimit: 'Gain Limit',
          maxGain: 'Max Gain',
          wdr: 'WDR',
          wdrLevel: 'WDR Level',
          blc: 'Backlight Comp',
          backlightCompensation: 'Backlight Comp',
          exposureCompensation: 'Exposure Comp',
          meteringMode: 'Metering Mode'
        }
      },
      lowLight: {
        label: 'Low-Light Strategy',
        icon: '[*]',
        fields: {
          irMode: 'IR Mode',
          irIntensity: 'IR Intensity',
          irCutFilter: 'IR Cut Filter',
          slowShutter: 'Slow Shutter',
          noiseReduction: 'Noise Reduction',
          dnr: 'DNR Level',
          '3dnr': '3D-NR',
          dayNightMode: 'Day/Night Mode',
          sensitivity: 'Sensitivity'
        }
      },
      image: {
        label: 'Image Processing',
        icon: '[#]',
        fields: {
          sharpness: 'Sharpness',
          sharpening: 'Sharpening',
          contrast: 'Contrast',
          saturation: 'Saturation',
          brightness: 'Brightness',
          hue: 'Hue',
          gamma: 'Gamma',
          whiteBalance: 'White Balance',
          colorMode: 'Color Mode',
          mirror: 'Mirror',
          flip: 'Flip',
          rotation: 'Rotation',
          defog: 'Defog',
          ldc: 'Lens Distortion Corr.'
        }
      },
      focus: {
        label: 'Focus & Zoom',
        icon: '[+]',
        fields: {
          focusMode: 'Focus Mode',
          autoFocus: 'Auto Focus',
          zoom: 'Zoom Level',
          digitalZoom: 'Digital Zoom'
        }
      }
    };

    // Capability categories for camera bay display
    const CAPABILITIES_CATEGORIES = {
      device: {
        label: 'Device Information',
        icon: '[i]',
        fields: {
          manufacturer: 'Manufacturer',
          vendor: 'Vendor',
          model: 'Model',
          firmware: 'Firmware',
          serial: 'Serial Number',
          hardware_id: 'Hardware ID'
        }
      },
      streaming: {
        label: 'Streaming Capabilities',
        icon: '[>]',
        fields: {
          max_resolution: 'Max Resolution',
          maxResolution: 'Max Resolution',
          supported_codecs: 'Supported Codecs',
          codecs: 'Codecs',
          supportedCodecs: 'Supported Codecs',
          max_fps: 'Max FPS',
          maxFps: 'Max FPS',
          resolutions: 'Resolutions'
        }
      },
      profiles: {
        label: 'ONVIF Profiles',
        icon: '[P]',
        fields: {
          profile_t_supported: 'Profile T',
          profile_s_supported: 'Profile S',
          media2_supported: 'Media2 Service',
          h265_supported: 'H.265/HEVC',
          h265_profiles: 'H.265 Profiles',
          max_h265_resolution: 'Max H.265 Resolution'
        }
      },
      services: {
        label: 'Available Services',
        icon: '[S]',
        fields: {
          has_imaging_service: 'Imaging Service',
          analytics: 'Analytics',
          ptz: 'PTZ Control',
          events: 'Events'
        }
      }
    };

    // Current settings categories for camera bay display
    const CURRENT_SETTINGS_CATEGORIES = {
      stream: {
        label: 'Stream Configuration',
        icon: '[>]',
        fields: {
          resolution: 'Resolution',
          codec: 'Codec',
          fps: 'Frame Rate',
          bitrateMbps: 'Bitrate (Mbps)'
        }
      },
      exposure: {
        label: 'Exposure Settings',
        icon: '[O]',
        fields: {
          mode: 'Mode',
          shutter: 'Shutter',
          iris: 'Iris',
          gainLimit: 'Gain Limit',
          wdr: 'WDR',
          wdrLevel: 'WDR Level'
        }
      },
      lowLight: {
        label: 'Low-Light Settings',
        icon: '[*]',
        fields: {
          irMode: 'IR Mode',
          dayNightMode: 'Day/Night',
          noiseReduction: 'Noise Reduction'
        }
      },
      image: {
        label: 'Image Quality',
        icon: '[#]',
        fields: {
          brightness: 'Brightness',
          contrast: 'Contrast',
          saturation: 'Saturation',
          sharpness: 'Sharpness'
        }
      }
    };

    function formatSettingValue(value) {
      if (value === null || value === undefined) return 'â€”';
      if (typeof value === 'boolean') return value ? 'ON' : 'OFF';
      if (Array.isArray(value)) return value.length > 0 ? value.join(', ') : 'â€”';
      if (typeof value === 'number') return value.toString();
      return String(value);
    }

    function formatCapabilities(capabilities) {
      if (!capabilities) return '<div style="color: var(--text-dim);">No capabilities data</div>';

      let html = '<div class="settings-report" style="padding: 0;">';

      // Process device info first (might be nested or flat)
      const deviceData = capabilities.device || {
        manufacturer: capabilities.vendor || capabilities.manufacturer,
        model: capabilities.model,
        firmware: capabilities.firmware,
        serial: capabilities.serial || capabilities.serialNumber
      };

      // Build flat capability data for easier processing
      const flatCaps = {
        device: deviceData,
        streaming: {
          max_resolution: capabilities.max_resolution || capabilities.maxResolution,
          codecs: capabilities.codecs || capabilities.supported_codecs || capabilities.supportedCodecs,
          max_fps: capabilities.max_fps || capabilities.maxFps,
          resolutions: capabilities.resolutions
        },
        profiles: {
          profile_t_supported: capabilities.profile_t_supported,
          profile_s_supported: capabilities.profile_s_supported,
          media2_supported: capabilities.media2_supported,
          h265_supported: capabilities.h265_supported,
          h265_profiles: capabilities.h265_profiles,
          max_h265_resolution: capabilities.max_h265_resolution
        },
        services: {
          has_imaging_service: capabilities.has_imaging_service,
          analytics: capabilities.service_capabilities?.analytics,
          ptz: capabilities.service_capabilities?.ptz,
          events: capabilities.service_capabilities?.events
        }
      };

      for (const [catKey, category] of Object.entries(CAPABILITIES_CATEGORIES)) {
        const catData = flatCaps[catKey];
        if (!catData) continue;

        const items = [];
        for (const [fieldKey, fieldLabel] of Object.entries(category.fields)) {
          const value = catData[fieldKey];
          if (value !== undefined && value !== null && value !== '') {
            items.push({ label: fieldLabel, value: formatSettingValue(value) });
          }
        }

        if (items.length === 0) continue;

        html += `
          <div class="settings-category">
            <div class="settings-category-header">
              <span class="settings-category-icon">${category.icon}</span>
              ${category.label}
            </div>
            <div class="settings-grid">
              ${items.map(item => `
                <div class="settings-item">
                  <span class="settings-item-label">${escapeHtml(item.label)}</span>
                  <span class="settings-item-value">${escapeHtml(item.value)}</span>
                </div>
              `).join('')}
            </div>
          </div>`;
      }

      // Show video encoder details if available
      if (capabilities.video_encoders && capabilities.video_encoders.length > 0) {
        const encoder = capabilities.video_encoders[0];
        html += `
          <div class="settings-category">
            <div class="settings-category-header">
              <span class="settings-category-icon">[E]</span>
              Primary Encoder
            </div>
            <div class="settings-grid">
              <div class="settings-item">
                <span class="settings-item-label">Name</span>
                <span class="settings-item-value">${escapeHtml(encoder.name || 'â€”')}</span>
              </div>
              <div class="settings-item">
                <span class="settings-item-label">Encoding</span>
                <span class="settings-item-value">${escapeHtml(encoder.encoding || 'â€”')}</span>
              </div>
              <div class="settings-item">
                <span class="settings-item-label">Resolution</span>
                <span class="settings-item-value">${encoder.resolution ? encoder.resolution.width + 'x' + encoder.resolution.height : 'â€”'}</span>
              </div>
              <div class="settings-item">
                <span class="settings-item-label">FPS</span>
                <span class="settings-item-value">${encoder.fps || 'â€”'}</span>
              </div>
              <div class="settings-item">
                <span class="settings-item-label">Bitrate</span>
                <span class="settings-item-value">${encoder.bitrate_limit ? (encoder.bitrate_limit / 1000).toFixed(1) + ' Mbps' : 'â€”'}</span>
              </div>
              <div class="settings-item">
                <span class="settings-item-label">Quality</span>
                <span class="settings-item-value">${encoder.quality || 'â€”'}</span>
              </div>
            </div>
          </div>`;
      }

      // Show media profiles if available
      if (capabilities.media_profiles && capabilities.media_profiles.length > 0) {
        html += `
          <div class="settings-category">
            <div class="settings-category-header">
              <span class="settings-category-icon">[M]</span>
              Media Profiles (${capabilities.media_profiles.length})
            </div>
            <div class="settings-grid">
              ${capabilities.media_profiles.slice(0, 4).map(p => `
                <div class="settings-item">
                  <span class="settings-item-label">${escapeHtml(p.name || p.token)}</span>
                  <span class="settings-item-value">${escapeHtml(p.resolution || p.encoding || 'â€”')}</span>
                </div>
              `).join('')}
            </div>
          </div>`;
      }

      html += '</div>';
      return html;
    }

    function formatCurrentSettingsForBay(currentSettings) {
      if (!currentSettings) return '<div style="color: var(--text-dim);">No settings data</div>';

      let html = '<div class="settings-report" style="padding: 0;">';

      for (const [catKey, category] of Object.entries(CURRENT_SETTINGS_CATEGORIES)) {
        const catData = currentSettings[catKey];
        if (!catData || typeof catData !== 'object') continue;

        const items = [];
        for (const [fieldKey, fieldLabel] of Object.entries(category.fields)) {
          const value = catData[fieldKey];
          if (value !== undefined && value !== null && value !== '' && value !== 'Unknown') {
            items.push({ label: fieldLabel, value: formatSettingValue(value) });
          }
        }
        // Capture additional fields not in predefined list
        for (const [key, value] of Object.entries(catData)) {
          if (!category.fields[key] && value !== undefined && value !== null && value !== '' && value !== 'Unknown') {
            const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
            items.push({ label, value: formatSettingValue(value) });
          }
        }

        if (items.length === 0) continue;

        html += `
          <div class="settings-category">
            <div class="settings-category-header">
              <span class="settings-category-icon">${category.icon}</span>
              ${category.label}
            </div>
            <div class="settings-grid">
              ${items.map(item => `
                <div class="settings-item">
                  <span class="settings-item-label">${escapeHtml(item.label)}</span>
                  <span class="settings-item-value">${escapeHtml(item.value)}</span>
                </div>
              `).join('')}
            </div>
          </div>`;
      }

      html += '</div>';
      return html || '<div style="color: var(--text-dim);">No settings data available</div>';
    }

    function formatSettingsReport(result) {
      const settings = result.recommendedSettings || {};
      const confidence = result.confidence || 0;
      const confPct = Math.round(confidence * 100);
      const confClass = confPct >= 80 ? 'high' : confPct >= 60 ? 'medium' : 'low';
      const provider = result.aiProvider === 'heuristic' ? 'HEURISTIC' : 'CLAUDE AI';
      const processingTime = result.processingTime ? `${result.processingTime.toFixed(1)}s` : 'â€”';

      let html = `
        <div class="settings-report">
          <div class="settings-report-header">
            <div class="settings-report-title">OPTIMIZATION COMPLETE</div>
            <div class="settings-report-meta">
              <div class="settings-report-meta-item">
                <span class="settings-report-meta-label">CONFIDENCE:</span>
                <span class="settings-report-meta-value ${confClass}">${confPct}%</span>
              </div>
              <div class="settings-report-meta-item">
                <span class="settings-report-meta-label">PROVIDER:</span>
                <span class="settings-report-meta-value">${provider}</span>
              </div>
              <div class="settings-report-meta-item">
                <span class="settings-report-meta-label">PROCESSING:</span>
                <span class="settings-report-meta-value">${processingTime}</span>
              </div>
            </div>
          </div>`;

      // Render each category that has data
      for (const [catKey, category] of Object.entries(SETTINGS_CATEGORIES)) {
        const catData = settings[catKey];
        if (!catData || typeof catData !== 'object') continue;

        const items = [];
        for (const [fieldKey, fieldLabel] of Object.entries(category.fields)) {
          if (catData[fieldKey] !== undefined) {
            items.push({ label: fieldLabel, value: formatSettingValue(catData[fieldKey]) });
          }
        }
        // Also capture any fields not in our predefined list
        for (const [key, value] of Object.entries(catData)) {
          if (!category.fields[key] && value !== undefined) {
            const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
            items.push({ label, value: formatSettingValue(value) });
          }
        }

        if (items.length === 0) continue;

        html += `
          <div class="settings-category">
            <div class="settings-category-header">
              <span class="settings-category-icon">${category.icon}</span>
              ${category.label}
            </div>
            <div class="settings-grid">
              ${items.map(item => `
                <div class="settings-item">
                  <span class="settings-item-label">${escapeHtml(item.label)}</span>
                  <span class="settings-item-value">${escapeHtml(item.value)}</span>
                </div>
              `).join('')}
            </div>
          </div>`;
      }

      // Handle any top-level settings not in categories
      const uncategorized = [];
      for (const [key, value] of Object.entries(settings)) {
        if (!SETTINGS_CATEGORIES[key] && typeof value !== 'object') {
          const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
          uncategorized.push({ label, value: formatSettingValue(value) });
        }
      }
      if (uncategorized.length > 0) {
        html += `
          <div class="settings-category">
            <div class="settings-category-header">
              <span class="settings-category-icon">[?]</span>
              Other Settings
            </div>
            <div class="settings-grid">
              ${uncategorized.map(item => `
                <div class="settings-item">
                  <span class="settings-item-label">${escapeHtml(item.label)}</span>
                  <span class="settings-item-value">${escapeHtml(item.value)}</span>
                </div>
              `).join('')}
            </div>
          </div>`;
      }

      // Explanation section
      if (result.explanation) {
        html += `
          <div class="settings-explanation">
            <div class="settings-explanation-header">Analysis Notes</div>
            <div class="settings-explanation-text">${escapeHtml(result.explanation)}</div>
          </div>`;
      }

      // Warnings section
      if (result.warnings && result.warnings.length > 0) {
        html += `
          <div class="settings-warnings">
            <div class="settings-warnings-header">Warnings</div>
            ${result.warnings.map(w => `
              <div class="settings-warning-item">${escapeHtml(w)}</div>
            `).join('')}
          </div>`;
      }

      html += '</div>';
      return html;
    }

    function displayOptimizationResult(result) {
      const output = document.getElementById('optimize-output');
      output.innerHTML = formatSettingsReport(result);
      output.parentElement.scrollTop = 0;
    }

    // ---- Results Detail Modal ----
    function formatSettingsForModal(settings) {
      let html = '';

      for (const [catKey, category] of Object.entries(SETTINGS_CATEGORIES)) {
        const catData = settings[catKey];
        if (!catData || typeof catData !== 'object') continue;

        const items = [];
        for (const [fieldKey, fieldLabel] of Object.entries(category.fields)) {
          if (catData[fieldKey] !== undefined) {
            items.push({ label: fieldLabel, value: formatSettingValue(catData[fieldKey]) });
          }
        }
        for (const [key, value] of Object.entries(catData)) {
          if (!category.fields[key] && value !== undefined) {
            const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
            items.push({ label, value: formatSettingValue(value) });
          }
        }

        if (items.length === 0) continue;

        html += `
          <div class="settings-category">
            <div class="settings-category-header">
              <span class="settings-category-icon">${category.icon}</span>
              ${category.label}
            </div>
            <div class="settings-grid">
              ${items.map(item => `
                <div class="settings-item">
                  <span class="settings-item-label">${escapeHtml(item.label)}</span>
                  <span class="settings-item-value">${escapeHtml(item.value)}</span>
                </div>
              `).join('')}
            </div>
          </div>`;
      }

      // Handle uncategorized top-level settings
      const uncategorized = [];
      for (const [key, value] of Object.entries(settings)) {
        if (!SETTINGS_CATEGORIES[key] && typeof value !== 'object') {
          const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
          uncategorized.push({ label, value: formatSettingValue(value) });
        }
      }
      if (uncategorized.length > 0) {
        html += `
          <div class="settings-category">
            <div class="settings-category-header">
              <span class="settings-category-icon">[?]</span>
              Other Settings
            </div>
            <div class="settings-grid">
              ${uncategorized.map(item => `
                <div class="settings-item">
                  <span class="settings-item-label">${escapeHtml(item.label)}</span>
                  <span class="settings-item-value">${escapeHtml(item.value)}</span>
                </div>
              `).join('')}
            </div>
          </div>`;
      }

      return html || '<div style="color: var(--text-dim);">No settings data available</div>';
    }

    function showOptimizationDetail(cameraId) {
      const opt = getCurrentOptimizations().filter(o => o.cameraId === cameraId)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

      if (!opt) return;

      const cam = getCurrentCameras().find(c => c.id === cameraId) || {};
      const modal = document.getElementById('detail-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      title.textContent = `${cameraId} - Optimization Details`;

      const confPct = Math.round(opt.confidence * 100);
      const confClass = confPct >= 80 ? 'confidence-high' : confPct >= 60 ? 'confidence-medium' : 'confidence-low';
      const provider = opt.aiProvider === 'heuristic' ? 'HEURISTIC' : 'CLAUDE AI';

      body.innerHTML = `
        <div class="form-section">
          <div class="section-header">// Summary</div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div>
              <div style="color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase;">Confidence</div>
              <div class="${confClass}" style="font-size: 1.5rem;">${confPct}%</div>
            </div>
            <div>
              <div style="color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase;">Provider</div>
              <div style="font-size: 1rem;">${provider}</div>
            </div>
            <div>
              <div style="color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase;">Date</div>
              <div style="font-size: 1rem;">${new Date(opt.timestamp).toLocaleString()}</div>
            </div>
          </div>
        </div>

        ${opt.explanation ? `
        <div class="form-section">
          <div class="section-header">// Analysis Notes</div>
          <div class="settings-explanation" style="margin-top: 0;">
            <div class="settings-explanation-text">${escapeHtml(opt.explanation)}</div>
          </div>
        </div>
        ` : ''}

        ${opt.warnings && opt.warnings.length > 0 ? `
        <div class="form-section">
          <div class="section-header">// Warnings</div>
          <div class="settings-warnings" style="margin-top: 0;">
            ${opt.warnings.map(w => `<div class="settings-warning-item">${escapeHtml(w)}</div>`).join('')}
          </div>
        </div>
        ` : ''}

        <div class="form-section">
          <div class="section-header">// Recommended Settings</div>
          <div class="settings-report" style="margin-top: 10px;">
            ${formatSettingsForModal(opt.settings || {})}
          </div>
        </div>

        <div class="action-bar">
          <button class="btn" onclick="applySettings('${escapeHtml(cameraId)}')">Apply Settings</button>
          <button class="btn btn-secondary" onclick="reoptimize('${escapeHtml(cameraId)}')">Re-optimize</button>
          <button class="btn btn-secondary" onclick="copySettingsJson('${escapeHtml(cameraId)}')">Copy JSON</button>
        </div>
      `;

      modal.classList.add('active');
    }

    function copySettingsJson(cameraId) {
      const opt = getCurrentOptimizations().filter(o => o.cameraId === cameraId)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
      if (!opt) return;

      const json = JSON.stringify(opt.settings, null, 2);
      navigator.clipboard.writeText(json).then(() => {
        showToast('Settings JSON copied to clipboard');
      }).catch(() => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = json;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Settings JSON copied to clipboard');
      });
    }

    document.getElementById('modal-close').addEventListener('click', () => {
      document.getElementById('detail-modal').classList.remove('active');
    });

    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') {
        document.getElementById('detail-modal').classList.remove('active');
      }
    });

    async function applySettings(cameraId) {
      const cam = getCurrentCameras().find(c => c.id === cameraId);
      const opt = getCurrentOptimizations().filter(o => o.cameraId === cameraId)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

      if (!cam || !opt) {
        alert('Camera or optimization not found');
        return;
      }

      if (!confirm(`Apply settings to ${cameraId}?`)) return;

      try {
        const response = await fetch(`${API_BASE}/api/apply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            camera: {
              id: cam.id,
              ip: cam.ip,
              vmsSystem: cam.vmsSystem,
              vmsCameraId: cam.vmsCameraId
            },
            settings: opt.settings,
            applyVia: cam.vmsSystem === 'hanwha-wave' ? 'vms' : 'onvif',
            verifyAfterApply: true
          })
        });

        const result = await response.json();

        if (result.status === 'error') {
          alert('Apply failed: ' + (result.error?.message || 'Unknown error'));
        } else {
          showToast('Settings applied successfully');
        }

      } catch (error) {
        alert('Apply failed: ' + error.message);
      }
    }

    function reoptimize(cameraId) {
      document.getElementById('detail-modal').classList.remove('active');

      // Switch to optimize section
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      document.querySelector('.nav-item[data-section="optimize"]').classList.add('active');
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('section-optimize').classList.add('active');

      // Select camera
      document.getElementById('optimize-camera-select').value = cameraId;
    }

    // ---- Health Monitoring ----
    document.getElementById('health-schedule-form').addEventListener('submit', (e) => {
      e.preventDefault();

      if (!getCurrentSite()) {
        alert('Please create or select a site first');
        return;
      }

      const selectedCameras = [];
      document.querySelectorAll('.health-camera-checkbox:checked').forEach(cb => {
        selectedCameras.push(cb.value);
      });

      if (selectedCameras.length === 0) {
        alert('Please select at least one camera');
        return;
      }

      const interval = document.getElementById('health-interval').value;
      const timeOfDay = document.getElementById('health-time').value;
      const threshold = parseInt(document.getElementById('health-threshold').value);

      // Create/update schedules
      selectedCameras.forEach(cameraId => {
        const schedule = {
          cameraId,
          interval,
          timeOfDay,
          threshold,
          enabled: true,
          lastCheck: null,
          nextCheck: calculateNextCheck(interval, timeOfDay),
          lastHealth: null
        };

        updateHealthScheduleInCurrentSite(cameraId, schedule);
      });

      updateUI();
      showToast('Health schedule saved');
    });

    function calculateNextCheck(interval, timeOfDay) {
      const now = new Date();
      const [hours, minutes] = timeOfDay.split(':').map(Number);
      const next = new Date(now);
      next.setHours(hours, minutes, 0, 0);

      if (next <= now) {
        if (interval === 'hourly') next.setHours(next.getHours() + 1);
        else if (interval === 'daily') next.setDate(next.getDate() + 1);
        else if (interval === 'weekly') next.setDate(next.getDate() + 7);
      }

      return next.toISOString();
    }

    document.getElementById('health-check-now-btn').addEventListener('click', async () => {
      if (!getCurrentSite()) {
        alert('Please create or select a site first');
        return;
      }

      const selectedCameras = [];
      document.querySelectorAll('.health-camera-checkbox:checked').forEach(cb => {
        selectedCameras.push(cb.value);
      });

      if (selectedCameras.length === 0) {
        alert('Please select at least one camera');
        return;
      }

      showToast('Running health check...');

      for (const cameraId of selectedCameras) {
        const cam = getCurrentCameras().find(c => c.id === cameraId);
        if (!cam) continue;

        try {
          // Get last optimization for comparison
          const lastOpt = getCurrentOptimizations().filter(o => o.cameraId === cameraId)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

          // Run a quick optimization check
          const response = await fetch(`${API_BASE}/api/optimize`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              camera: { id: cam.id, ip: cam.ip, sceneType: 'entrance', purpose: 'overview' },
              capabilities: { maxResolution: "1920x1080", supportedCodecs: ["H.264"], maxFps: 30 },
              currentSettings: { stream: {}, exposure: {}, lowLight: {} },
              context: { bandwidthLimitMbps: 4.0, targetRetentionDays: 30 }
            })
          });

          const result = await response.json();

          // Update health schedule
          const healthData = {
            confidence: result.confidence,
            driftDetected: lastOpt ? Math.abs(result.confidence - lastOpt.confidence) > 0.15 : false,
            checkedAt: new Date().toISOString()
          };

          updateHealthScheduleInCurrentSite(cameraId, {
            cameraId,
            interval: 'daily',
            timeOfDay: '02:00',
            threshold: 70,
            enabled: false,
            lastCheck: new Date().toISOString(),
            nextCheck: null,
            lastHealth: healthData
          });

        } catch (error) {
          console.error('Health check failed for', cameraId, error);
        }
      }

      updateUI();
      showToast('Health check complete');
    });

    // ---- Storage Calculator ----
    document.getElementById('calc-calculate-btn').addEventListener('click', () => {
      calculateStorageEstimate();
    });

    document.getElementById('calc-from-site-btn').addEventListener('click', () => {
      const cameras = getCurrentCameras();
      if (!cameras || cameras.length === 0) {
        showToast('No cameras in current site');
        return;
      }
      document.getElementById('calc-cameras').value = cameras.length;
      calculateStorageEstimate();
    });

    function calculateStorageEstimate() {
      const cameras = parseInt(document.getElementById('calc-cameras').value) || 1;
      const resolution = parseFloat(document.getElementById('calc-resolution').value) || 2;
      const fps = parseInt(document.getElementById('calc-fps').value) || 15;
      const hours = parseInt(document.getElementById('calc-hours').value) || 24;
      const codec = parseFloat(document.getElementById('calc-codec').value) || 1.0;
      const retention = parseInt(document.getElementById('calc-retention').value) || 30;
      const activity = parseFloat(document.getElementById('calc-activity').value) || 0.8;

      // Base bitrate calculation (Mbps)
      // 2MP @ 15fps H.264 VBR ~ 2 Mbps average
      const baseBitrate = resolution * (fps / 15) * activity;
      const perCameraBitrate = baseBitrate * codec;
      const totalBandwidth = perCameraBitrate * cameras;

      // Storage calculation
      // Mbps -> MB/s = Mbps / 8
      // MB/hour = MB/s * 3600
      // GB/day = MB/hour * hours / 1000
      // TB total = GB/day * retention / 1000
      const mbPerSecond = totalBandwidth / 8;
      const gbPerDay = (mbPerSecond * 3600 * hours) / 1000;
      const tbTotal = (gbPerDay * retention) / 1000;

      // Update UI
      document.getElementById('calc-per-camera').textContent = perCameraBitrate.toFixed(1) + ' Mbps';
      document.getElementById('calc-bandwidth').textContent = totalBandwidth.toFixed(1) + ' Mbps';
      document.getElementById('calc-daily').textContent = gbPerDay.toFixed(0) + ' GB';
      document.getElementById('calc-total').textContent = tbTotal.toFixed(2) + ' TB';

      // Show results
      document.getElementById('calc-results').style.display = 'none';
      document.getElementById('calc-output').style.display = 'block';
    }

    // ---- Utilities ----
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message) {
      // Simple toast notification
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--orange-primary);
        color: #000;
        padding: 12px 20px;
        font-size: 0.85rem;
        font-weight: bold;
        z-index: 1001;
        animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ========== MQTT Events Functions ==========

    let mqttEventBuffer = [];
    const MAX_EVENT_BUFFER = 500;
    let mqttStatusInterval = null;

    // Update MQTT status badge
    function updateMqttStatus(state, text) {
      const badge = document.getElementById('mqtt-status-badge');
      const textEl = document.getElementById('mqtt-status-text');

      badge.className = state; // connected, connecting, disconnected, error
      textEl.textContent = text;
    }

    // Connect to MQTT broker
    async function connectMqttBroker() {
      const host = document.getElementById('mqtt-host').value || 'localhost';
      const port = parseInt(document.getElementById('mqtt-port').value) || 1883;
      const username = document.getElementById('mqtt-username').value;
      const password = document.getElementById('mqtt-password').value;
      const useTls = document.getElementById('mqtt-use-tls').checked;

      try {
        updateMqttStatus('connecting', 'Connecting...');
        document.getElementById('mqtt-connect-btn').disabled = true;

        const response = await fetch(`${API_BASE}/api/mqtt/connect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ host, port, username, password, use_tls: useTls })
        });

        const result = await response.json();

        if (result.success) {
          updateMqttStatus('connected', 'Connected');
          document.getElementById('mqtt-connect-btn').disabled = true;
          document.getElementById('mqtt-disconnect-btn').disabled = false;
          document.getElementById('mqtt-configure-camera-btn').disabled = false;
          document.getElementById('mqtt-stats-section').style.display = 'block';
          startMqttStatusPolling();
          showToast('Connected to MQTT broker');
        } else {
          throw new Error(result.error || 'Connection failed');
        }
      } catch (error) {
        updateMqttStatus('error', 'Failed');
        document.getElementById('mqtt-connect-btn').disabled = false;
        showToast('MQTT connection failed: ' + error.message);
      }
    }

    // Disconnect from MQTT broker
    async function disconnectMqttBroker() {
      try {
        await fetch(`${API_BASE}/api/mqtt/disconnect`, { method: 'POST' });
        updateMqttStatus('disconnected', 'Disconnected');
        document.getElementById('mqtt-connect-btn').disabled = false;
        document.getElementById('mqtt-disconnect-btn').disabled = true;
        document.getElementById('mqtt-configure-camera-btn').disabled = true;
        document.getElementById('mqtt-stats-section').style.display = 'none';
        stopMqttStatusPolling();
        showToast('Disconnected from MQTT broker');
      } catch (error) {
        showToast('Disconnect failed: ' + error.message);
      }
    }

    // Start polling MQTT status
    function startMqttStatusPolling() {
      if (mqttStatusInterval) return;
      mqttStatusInterval = setInterval(fetchMqttStatus, 5000);
      fetchMqttStatus(); // Initial fetch
    }

    // Stop polling MQTT status
    function stopMqttStatusPolling() {
      if (mqttStatusInterval) {
        clearInterval(mqttStatusInterval);
        mqttStatusInterval = null;
      }
    }

    // Fetch MQTT status from backend
    async function fetchMqttStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/mqtt/status`);
        const status = await response.json();

        if (!status.available) {
          updateMqttStatus('error', 'Unavailable');
          return;
        }

        if (status.connected) {
          updateMqttStatus('connected', 'Connected');
          document.getElementById('mqtt-stats-section').style.display = 'block';
        }

        if (status.stats) {
          document.getElementById('mqtt-stat-received').textContent = status.stats.events_received || 0;
          document.getElementById('mqtt-stat-processed').textContent = status.stats.events_processed || 0;
          document.getElementById('mqtt-stat-dropped').textContent = status.stats.events_dropped || 0;
          document.getElementById('mqtt-stat-last-event').textContent =
            status.stats.last_event_time ? formatEventTime(status.stats.last_event_time) : '--';

          // Update badge
          document.getElementById('events-badge').textContent = status.stats.events_received || 0;
        }

        // Update configured cameras list
        if (status.cameras && status.cameras.length > 0) {
          document.getElementById('mqtt-cameras-section').style.display = 'block';
          updateMqttCamerasList(status.cameras);
        }
      } catch (error) {
        console.error('Failed to fetch MQTT status:', error);
      }
    }

    // Format event timestamp
    function formatEventTime(isoString) {
      if (!isoString) return '--';
      const date = new Date(isoString);
      return date.toLocaleTimeString();
    }

    // Update MQTT camera selector
    function updateMqttCameraSelector() {
      const select = document.getElementById('mqtt-camera-select');
      if (!select) return;

      const cameras = getCurrentCameras();
      select.innerHTML = '<option value="">-- Select Camera --</option>' +
        cameras.map(cam => `<option value="${cam.ip}">${escapeHtml(cam.ip)} - ${escapeHtml(cam.vendor || cam.id || 'Unknown')}</option>`).join('');
    }

    // Configure camera MQTT
    async function configureCameraMqtt() {
      const cameraIp = document.getElementById('mqtt-camera-select').value;
      const topicPrefix = document.getElementById('mqtt-topic-prefix').value;

      if (!cameraIp) {
        showToast('Please select a camera');
        return;
      }

      const creds = sessionCredentials[cameraIp];
      if (!creds) {
        showToast('No credentials cached for this camera. Re-add the camera with credentials.');
        return;
      }

      const cam = getCurrentCameras().find(c => c.ip === cameraIp);

      try {
        document.getElementById('mqtt-configure-camera-btn').disabled = true;

        const response = await fetch(`${API_BASE}/api/mqtt/camera/configure`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            camera_ip: cameraIp,
            camera_port: cam?.port || 80,
            username: creds.username,
            password: creds.password,
            topic_prefix: topicPrefix || undefined
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast(`Configured MQTT for ${cameraIp}`);
          fetchMqttStatus();
        } else {
          showToast(`Configuration failed: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        showToast('Failed to configure camera: ' + error.message);
      } finally {
        document.getElementById('mqtt-configure-camera-btn').disabled = false;
      }
    }

    // Remove camera MQTT configuration
    async function removeCameraMqtt() {
      const cameraIp = document.getElementById('mqtt-camera-select').value;

      if (!cameraIp) {
        showToast('Please select a camera');
        return;
      }

      const creds = sessionCredentials[cameraIp];
      if (!creds) {
        showToast('No credentials cached for this camera');
        return;
      }

      try {
        const response = await fetch(
          `${API_BASE}/api/mqtt/camera/${cameraIp}?username=${encodeURIComponent(creds.username)}&password=${encodeURIComponent(creds.password)}`,
          { method: 'DELETE' }
        );

        const result = await response.json();

        if (result.success) {
          showToast(`Removed MQTT config from ${cameraIp}`);
          fetchMqttStatus();
        } else {
          showToast(`Removal failed: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        showToast('Failed to remove config: ' + error.message);
      }
    }

    // Update MQTT cameras list UI
    function updateMqttCamerasList(cameras) {
      const list = document.getElementById('mqtt-cameras-list');

      if (!cameras || cameras.length === 0) {
        list.innerHTML = '<div style="color: var(--text-dim); font-size: 0.85rem;">No cameras configured</div>';
        return;
      }

      list.innerHTML = cameras.map(camId => `
        <div class="mqtt-camera-item">
          <span style="color: var(--orange-glow);">${escapeHtml(camId)}</span>
          <span class="status-badge connected" style="font-size: 0.65rem; padding: 2px 6px;">
            <span class="status-dot" style="width: 4px; height: 4px;"></span>
            Publishing
          </span>
        </div>
      `).join('');
    }

    // Add event to log (for future real-time updates)
    function addEventToLog(event) {
      const logEl = document.getElementById('event-log');
      const emptyEl = document.getElementById('event-log-empty');

      if (emptyEl) emptyEl.style.display = 'none';

      mqttEventBuffer.unshift(event);
      if (mqttEventBuffer.length > MAX_EVENT_BUFFER) {
        mqttEventBuffer.pop();
      }

      renderEventLog();
    }

    // Render event log with filter
    function renderEventLog() {
      const logEl = document.getElementById('event-log');
      const filterType = document.getElementById('event-filter-type').value;

      const filteredEvents = filterType
        ? mqttEventBuffer.filter(e => (e.eventType || '').toLowerCase().includes(filterType))
        : mqttEventBuffer;

      if (filteredEvents.length === 0) {
        logEl.innerHTML = `
          <div class="empty-state" style="padding: 40px;">
            <div class="empty-state-icon">!</div>
            <div class="empty-state-text">${filterType ? 'No matching events' : 'No events received'}</div>
          </div>
        `;
        return;
      }

      logEl.innerHTML = filteredEvents.map(event => `
        <div class="event-log-item">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span class="event-type-badge ${getEventTypeClass(event.eventType)}">${escapeHtml(event.eventType || 'Unknown')}</span>
            <span style="color: var(--text-dim); font-size: 0.75rem;">${formatEventTime(event.timestamp)}</span>
          </div>
          <div style="font-size: 0.8rem;">
            <span style="color: var(--orange-glow);">${escapeHtml(event.cameraIp || 'Unknown')}</span>
            ${event.data ? `<span style="color: var(--text-dim);"> - ${escapeHtml(JSON.stringify(event.data).substring(0, 80))}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    // Get CSS class for event type
    function getEventTypeClass(eventType) {
      if (!eventType) return '';
      const type = eventType.toLowerCase();
      if (type.includes('motion')) return 'event-motion';
      if (type.includes('intrusion') || type.includes('tamper')) return 'event-alert';
      if (type.includes('line') || type.includes('cross')) return 'event-crossing';
      if (type.includes('face')) return 'event-face';
      return '';
    }

    // Clear event log
    function clearEventLog() {
      mqttEventBuffer = [];
      document.getElementById('event-log').innerHTML = `
        <div class="empty-state" id="event-log-empty">
          <div class="empty-state-icon">!</div>
          <div class="empty-state-text">No events received</div>
          <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 10px;">
            Connect to MQTT broker and configure cameras to see events
          </div>
        </div>
      `;
      document.getElementById('events-badge').textContent = '0';
    }

    // ========== TLS/Security Functions ==========

    // Check camera TLS certificate
    async function checkCameraTls(cameraIp) {
      try {
        showToast(`Checking TLS for ${cameraIp}...`);

        const response = await fetch(`${API_BASE}/api/camera/${cameraIp}/tls-certificate?port=443`);
        const result = await response.json();

        // Update camera object with TLS info
        const cameras = getCurrentCameras();
        const camIndex = cameras.findIndex(c => c.ip === cameraIp);
        if (camIndex >= 0) {
          cameras[camIndex].tlsInfo = result;
          saveState();
          updateCameraBay();
        }

        // Show result toast
        if (result.valid) {
          const msg = result.self_signed
            ? `Valid (self-signed), expires in ${result.days_until_expiry || '?'} days`
            : `Valid, issuer: ${result.issuer || 'Unknown'}`;
          showToast(msg);
        } else {
          showToast(`TLS check failed: ${result.error || 'Invalid certificate'}`);
        }

        return result;
      } catch (error) {
        showToast('TLS check failed: ' + error.message);
        return null;
      }
    }

    // Toggle discovery mode for camera
    async function toggleDiscoveryMode(cameraIp) {
      const creds = sessionCredentials[cameraIp];
      if (!creds) {
        showToast('No credentials cached. Re-add camera with credentials.');
        return;
      }

      const cameras = getCurrentCameras();
      const cam = cameras.find(c => c.ip === cameraIp);
      const currentMode = cam?.discoveryMode !== false; // default true (enabled)
      const newMode = !currentMode;

      try {
        showToast(`Setting discovery mode to ${newMode ? 'enabled' : 'disabled'}...`);

        const response = await fetch(`${API_BASE}/api/camera/discovery-mode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ip: cameraIp,
            port: cam?.port || 80,
            username: creds.username,
            password: creds.password,
            discoverable: newMode
          })
        });

        const result = await response.json();

        if (result.success !== false) {
          // Update camera object
          const camIndex = cameras.findIndex(c => c.ip === cameraIp);
          if (camIndex >= 0) {
            cameras[camIndex].discoveryMode = newMode;
            saveState();
            updateCameraBay();
          }
          showToast(`Discovery ${newMode ? 'enabled' : 'disabled'} for ${cameraIp}`);
        } else {
          showToast(`Failed: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        showToast('Failed to set discovery mode: ' + error.message);
      }
    }

    // ========== WebRTC Session Management ==========

    // Fetch active WebRTC sessions
    async function fetchWebRtcSessions() {
      try {
        const response = await fetch(`${API_BASE}/api/webrtc/sessions`);
        const data = await response.json();

        const countEl = document.getElementById('webrtc-session-count');
        if (countEl) {
          countEl.textContent = data.count || 0;
        }

        return data.sessions || [];
      } catch (error) {
        console.error('Failed to fetch WebRTC sessions:', error);
        return [];
      }
    }

    // Open WebRTC sessions modal
    async function openWebRtcSessionsModal() {
      const sessions = await fetchWebRtcSessions();
      const list = document.getElementById('webrtc-sessions-list');

      if (!sessions || sessions.length === 0) {
        list.innerHTML = `
          <div class="empty-state" style="padding: 30px;">
            <div class="empty-state-icon" style="font-size: 2rem;">â–¶</div>
            <div class="empty-state-text">No active sessions</div>
          </div>
        `;
      } else {
        list.innerHTML = sessions.map(session => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); margin-bottom: 8px; border: 1px solid var(--orange-dark); border-radius: 4px;">
            <div>
              <div style="color: var(--orange-glow); font-size: 0.9rem;">${escapeHtml(session.cameraIp || 'Unknown')}</div>
              <div style="font-size: 0.75rem; color: var(--text-dim);">
                Session: ${escapeHtml((session.sessionId || '').substring(0, 8))}... |
                State: ${escapeHtml(session.state || 'unknown')}
              </div>
            </div>
            <button onclick="closeWebRtcSession('${escapeHtml(session.sessionId)}')" class="btn btn-secondary btn-xs" style="background: var(--red-alert); border-color: var(--red-alert);">
              Close
            </button>
          </div>
        `).join('');
      }

      document.getElementById('webrtc-sessions-modal').classList.add('active');
    }

    // Close WebRTC session
    async function closeWebRtcSession(sessionId) {
      try {
        const response = await fetch(`${API_BASE}/api/webrtc/sessions/${sessionId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showToast('Session closed');
          openWebRtcSessionsModal(); // Refresh list
        } else {
          showToast('Failed to close session');
        }
      } catch (error) {
        showToast('Error closing session: ' + error.message);
      }
    }

    // Close WebRTC sessions modal
    function closeWebRtcSessionsModal() {
      document.getElementById('webrtc-sessions-modal').classList.remove('active');
    }

    // ---- Site Event Listeners ----
    document.getElementById('site-selector').addEventListener('change', (e) => {
      switchToSite(e.target.value || null);
    });

    document.getElementById('new-site-btn').addEventListener('click', () => {
      showSiteModal(false);
    });

    document.getElementById('save-site-btn').addEventListener('click', () => {
      exportCurrentSite();
    });

    document.getElementById('load-site-btn').addEventListener('click', () => {
      document.getElementById('site-import-input').click();
    });

    document.getElementById('site-import-input').addEventListener('change', (e) => {
      if (e.target.files[0]) {
        importSiteFromFile(e.target.files[0]);
        e.target.value = ''; // Reset input
      }
    });

    document.getElementById('delete-site-btn').addEventListener('click', () => {
      if (state.currentSiteId) {
        deleteSite(state.currentSiteId);
      }
    });

    // Site modal event listeners
    document.getElementById('site-modal-close').addEventListener('click', hideSiteModal);
    document.getElementById('site-form-cancel').addEventListener('click', hideSiteModal);

    document.getElementById('site-modal').addEventListener('click', (e) => {
      if (e.target.id === 'site-modal') {
        hideSiteModal();
      }
    });

    document.getElementById('site-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('site-name-input').value.trim();
      const description = document.getElementById('site-description-input').value.trim();
      const mode = document.getElementById('site-form-submit').dataset.mode;

      if (!name) {
        alert('Site name is required');
        return;
      }

      if (mode === 'edit' && getCurrentSite()) {
        const site = getCurrentSite();
        site.name = name;
        site.description = description;
        site.updatedAt = new Date().toISOString();
        saveState();
        updateUI();
        showToast('Site updated');
      } else {
        createSite(name, description);
        showToast('Site created: ' + name);
      }

      hideSiteModal();
    });

    // ---- WebRTC Live View ----

    // WebRTC client class
    class WebRTCLiveView {
      constructor() {
        this.ws = null;
        this.pc = null;
        this.sessionId = null;
        this.cameraIp = null;
        this.iceServers = [];
        this.state = 'disconnected';
        this.statsInterval = null;
      }

      async connect(cameraIp, cameraPort, username, password, profileToken = 'MainStream') {
        this.cameraIp = cameraIp;
        this.updateStatus('connecting', 'Connecting...');

        // Get WebSocket URL
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${new URL(API_BASE).host}/api/webrtc/stream`;

        try {
          // Connect WebSocket
          this.ws = new WebSocket(wsUrl);

          this.ws.onopen = () => {
            console.log('[WebRTC] WebSocket connected');
            this.updateStatus('connecting', 'WebSocket connected...');

            // Send connect request
            this.ws.send(JSON.stringify({
              type: 'connect',
              camera_ip: cameraIp,
              camera_port: cameraPort || 80,
              username: username,
              password: password,
              profile_token: profileToken
            }));
          };

          this.ws.onmessage = (event) => this.handleMessage(JSON.parse(event.data));

          this.ws.onerror = (error) => {
            console.error('[WebRTC] WebSocket error:', error);
            this.updateStatus('error', 'Connection error');
          };

          this.ws.onclose = () => {
            console.log('[WebRTC] WebSocket closed');
            if (this.state !== 'disconnected') {
              this.updateStatus('disconnected', 'Disconnected');
            }
            this.cleanup();
          };

        } catch (error) {
          console.error('[WebRTC] Connection failed:', error);
          this.updateStatus('error', error.message);
          throw error;
        }
      }

      handleMessage(msg) {
        console.log('[WebRTC] Received:', msg.type, msg);

        switch (msg.type) {
          case 'session':
            this.sessionId = msg.sessionId;
            this.iceServers = msg.iceServers || [];
            this.updateStatus('connecting', 'Session created...');
            this.updateConnectionStatus(`Session: ${this.sessionId.substring(0, 8)}...`);
            break;

          case 'registered':
            this.updateStatus('connecting', 'Registered with camera...');
            // Create peer connection and send offer
            this.createPeerConnection();
            break;

          case 'answer':
            this.handleAnswer(msg.sdp);
            break;

          case 'ice-candidate':
            this.handleRemoteIceCandidate(msg.candidate);
            break;

          case 'stream-opened':
            this.updateStatus('streaming', 'Streaming');
            this.startStats();
            break;

          case 'stream-closed':
            this.updateStatus('disconnected', 'Stream closed');
            this.disconnect();
            break;

          case 'rtsp-fallback':
            this.handleRtspFallback(msg);
            break;

          case 'error':
            console.error('[WebRTC] Error:', msg.code, msg.message);
            this.updateStatus('error', msg.message);
            break;

          case 'ping':
            // Keepalive, ignore
            break;

          default:
            console.log('[WebRTC] Unknown message type:', msg.type);
        }
      }

      async createPeerConnection() {
        this.updateStatus('connecting', 'Creating peer connection...');

        const config = {
          iceServers: this.iceServers.length > 0 ? this.iceServers : [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        };

        this.pc = new RTCPeerConnection(config);

        // Handle incoming tracks
        this.pc.ontrack = (event) => {
          console.log('[WebRTC] Track received:', event.track.kind);
          const video = document.getElementById('liveview-video');
          if (event.streams && event.streams[0]) {
            video.srcObject = event.streams[0];
            video.style.display = 'block';
            document.getElementById('liveview-placeholder').style.display = 'none';
            document.getElementById('liveview-snapshot-btn').disabled = false;
            document.getElementById('liveview-fullscreen-btn').disabled = false;
            this.updateStatus('streaming', 'Streaming');
          }
        };

        // Handle ICE candidates
        this.pc.onicecandidate = (event) => {
          if (event.candidate) {
            console.log('[WebRTC] Sending ICE candidate');
            this.ws.send(JSON.stringify({
              type: 'ice-candidate',
              candidate: event.candidate
            }));
          }
        };

        // Handle connection state changes
        this.pc.onconnectionstatechange = () => {
          console.log('[WebRTC] Connection state:', this.pc.connectionState);
          if (this.pc.connectionState === 'connected') {
            this.updateStatus('streaming', 'Connected');
            this.startStats();
          } else if (this.pc.connectionState === 'failed') {
            this.updateStatus('error', 'Connection failed');
          } else if (this.pc.connectionState === 'disconnected') {
            this.updateStatus('disconnected', 'Disconnected');
          }
        };

        // Handle ICE connection state
        this.pc.oniceconnectionstatechange = () => {
          console.log('[WebRTC] ICE state:', this.pc.iceConnectionState);
          this.updateConnectionStatus(`ICE: ${this.pc.iceConnectionState}`);
        };

        // Add transceiver for receiving video
        this.pc.addTransceiver('video', { direction: 'recvonly' });
        this.pc.addTransceiver('audio', { direction: 'recvonly' });

        // Create and send offer
        try {
          const offer = await this.pc.createOffer();
          await this.pc.setLocalDescription(offer);

          console.log('[WebRTC] Sending offer');
          this.ws.send(JSON.stringify({
            type: 'offer',
            sdp: offer.sdp
          }));

          this.updateStatus('connecting', 'Negotiating...');
        } catch (error) {
          console.error('[WebRTC] Failed to create offer:', error);
          this.updateStatus('error', 'Failed to create offer');
        }
      }

      async handleAnswer(sdp) {
        console.log('[WebRTC] Received answer');
        try {
          await this.pc.setRemoteDescription({
            type: 'answer',
            sdp: sdp
          });
          this.updateStatus('connecting', 'Answer received...');
        } catch (error) {
          console.error('[WebRTC] Failed to set remote description:', error);
          this.updateStatus('error', 'Failed to process answer');
        }
      }

      async handleRemoteIceCandidate(candidate) {
        if (this.pc && candidate) {
          try {
            await this.pc.addIceCandidate(candidate);
            console.log('[WebRTC] Added remote ICE candidate');
          } catch (error) {
            console.error('[WebRTC] Failed to add ICE candidate:', error);
          }
        }
      }

      handleRtspFallback(msg) {
        console.log('[WebRTC] RTSP fallback:', msg);
        this.updateStatus('fallback', 'RTSP Fallback');

        // Hide video placeholder, show RTSP fallback
        document.getElementById('liveview-placeholder').style.display = 'none';
        document.getElementById('liveview-rtsp-fallback').style.display = 'block';
        document.getElementById('liveview-rtsp-url').textContent = msg.rtspUrl || 'RTSP URL not available';

        // Store ICE servers for potential future use
        this.iceServers = msg.iceServers || [];
      }

      startStats() {
        if (this.statsInterval) return;

        this.statsInterval = setInterval(async () => {
          if (!this.pc) return;

          try {
            const stats = await this.pc.getStats();
            let videoStats = null;

            stats.forEach(report => {
              if (report.type === 'inbound-rtp' && report.kind === 'video') {
                videoStats = report;
              }
            });

            if (videoStats) {
              const statsEl = document.getElementById('liveview-stats');
              const fps = videoStats.framesPerSecond || 0;
              const width = videoStats.frameWidth || 0;
              const height = videoStats.frameHeight || 0;
              const bytesReceived = videoStats.bytesReceived || 0;
              const kbps = Math.round((bytesReceived * 8) / 1000);

              statsEl.innerHTML = `${width}x${height} @ ${Math.round(fps)} fps | ${kbps} kbps`;
            }
          } catch (e) {
            // Ignore stats errors
          }
        }, 1000);
      }

      updateStatus(state, text) {
        this.state = state;
        const statusEl = document.getElementById('liveview-status');

        const colors = {
          'disconnected': 'var(--text-dim)',
          'connecting': 'var(--orange-glow)',
          'streaming': 'var(--terminal-green)',
          'error': '#ff4444',
          'fallback': 'var(--orange-dark)'
        };

        statusEl.style.background = colors[state] || 'var(--bg-primary)';
        statusEl.style.color = state === 'streaming' ? '#000' : '#fff';
        statusEl.textContent = text;
      }

      updateConnectionStatus(text) {
        document.getElementById('liveview-connection-status').textContent = text;
      }

      takeSnapshot() {
        const video = document.getElementById('liveview-video');
        if (!video.videoWidth) return null;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        return canvas.toDataURL('image/jpeg', 0.9);
      }

      toggleFullscreen() {
        const container = document.getElementById('liveview-video-container');
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          container.requestFullscreen();
        }
      }

      disconnect() {
        console.log('[WebRTC] Disconnecting');

        if (this.ws) {
          try {
            this.ws.send(JSON.stringify({ type: 'close' }));
            this.ws.close();
          } catch (e) {}
          this.ws = null;
        }

        this.cleanup();
        this.updateStatus('disconnected', 'Disconnected');
      }

      cleanup() {
        if (this.statsInterval) {
          clearInterval(this.statsInterval);
          this.statsInterval = null;
        }

        if (this.pc) {
          this.pc.close();
          this.pc = null;
        }

        // Reset UI
        const video = document.getElementById('liveview-video');
        video.srcObject = null;
        video.style.display = 'none';
        document.getElementById('liveview-placeholder').style.display = 'block';
        document.getElementById('liveview-rtsp-fallback').style.display = 'none';
        document.getElementById('liveview-snapshot-btn').disabled = true;
        document.getElementById('liveview-fullscreen-btn').disabled = true;
        document.getElementById('liveview-stats').innerHTML = '';
        document.getElementById('liveview-connection-status').textContent = '';
      }
    }

    // Global live view instance
    let activeLiveView = null;

    // Open live view for a camera
    async function openLiveView(cameraIp) {
      const cam = getCurrentCameras().find(c => c.ip === cameraIp);
      if (!cam) {
        showToast('Camera not found');
        return;
      }

      const creds = sessionCredentials[cameraIp];
      if (!creds) {
        showToast('No credentials cached. Re-add camera with credentials.');
        return;
      }

      // Show modal
      document.getElementById('liveview-modal').classList.add('active');
      document.getElementById('liveview-title').textContent = `Live View - ${cam.ip}`;

      // Close any existing connection
      if (activeLiveView) {
        activeLiveView.disconnect();
      }

      // Create new connection
      activeLiveView = new WebRTCLiveView();

      try {
        await activeLiveView.connect(
          cam.ip,
          cam.port || 80,
          creds.username,
          creds.password
        );
      } catch (error) {
        console.error('Failed to open live view:', error);
        showToast('Failed to connect: ' + error.message);
      }
    }

    // Close live view
    function closeLiveView() {
      if (activeLiveView) {
        activeLiveView.disconnect();
        activeLiveView = null;
      }
      document.getElementById('liveview-modal').classList.remove('active');
    }

    // Live view modal event listeners
    document.getElementById('liveview-close').addEventListener('click', closeLiveView);

    document.getElementById('liveview-modal').addEventListener('click', (e) => {
      if (e.target.id === 'liveview-modal') {
        closeLiveView();
      }
    });

    document.getElementById('liveview-snapshot-btn').addEventListener('click', () => {
      if (activeLiveView) {
        const snapshot = activeLiveView.takeSnapshot();
        if (snapshot) {
          // Update camera snapshot
          const cam = getCurrentCameras().find(c => c.ip === activeLiveView.cameraIp);
          if (cam) {
            cam.snapshot = snapshot;
            saveState();
            updateCameraBay();
            showToast('Snapshot captured from live view');
          }
        }
      }
    });

    document.getElementById('liveview-fullscreen-btn').addEventListener('click', () => {
      if (activeLiveView) {
        activeLiveView.toggleFullscreen();
      }
    });

    // ---- MQTT Event Listeners ----
    document.getElementById('mqtt-connect-btn').addEventListener('click', connectMqttBroker);
    document.getElementById('mqtt-disconnect-btn').addEventListener('click', disconnectMqttBroker);
    document.getElementById('mqtt-configure-camera-btn').addEventListener('click', configureCameraMqtt);
    document.getElementById('mqtt-remove-camera-btn').addEventListener('click', removeCameraMqtt);
    document.getElementById('event-filter-type').addEventListener('change', renderEventLog);
    document.getElementById('event-clear-btn').addEventListener('click', clearEventLog);

    // Update MQTT camera selector when section is shown
    document.querySelector('.nav-item[data-section="events"]').addEventListener('click', () => {
      updateMqttCameraSelector();
    });

    // ---- WebRTC Sessions Event Listeners ----
    document.getElementById('webrtc-sessions-btn')?.addEventListener('click', openWebRtcSessionsModal);
    document.getElementById('webrtc-sessions-close')?.addEventListener('click', closeWebRtcSessionsModal);
    document.getElementById('webrtc-sessions-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'webrtc-sessions-modal') closeWebRtcSessionsModal();
    });

    // ---- Emergency Record ----
    let emergencyStatusInterval = null;
    let emergencyRecordingActive = false;

    function startEmergencyStatusPolling() {
      if (emergencyStatusInterval) return;
      emergencyStatusInterval = setInterval(fetchEmergencyStatus, 3000);
      fetchEmergencyStatus();
    }

    function stopEmergencyStatusPolling() {
      if (emergencyStatusInterval) {
        clearInterval(emergencyStatusInterval);
        emergencyStatusInterval = null;
      }
    }

    async function fetchEmergencyStatus() {
      const site = getCurrentSite();
      if (!site) {
        updateEmergencyIndicator(false);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/emergency-record/status/${site.id}`);
        const status = await response.json();

        if (status.active) {
          emergencyRecordingActive = true;
          updateEmergencyUI(status);
          updateEmergencyIndicator(true, status.camera_count || status.cameras?.length || 0);
        } else {
          emergencyRecordingActive = false;
          updateEmergencyIndicator(false);
          resetEmergencyUI();
        }
      } catch (error) {
        console.error('Failed to fetch emergency status:', error);
      }
    }

    function updateEmergencyIndicator(active, cameraCount = 0) {
      const indicator = document.getElementById('emergency-record-indicator');
      const badge = document.getElementById('emergency-badge');

      if (active) {
        indicator.style.display = 'flex';
        badge.style.display = 'inline';
        badge.textContent = '';
        document.getElementById('emergency-record-camera-count').textContent = cameraCount;
      } else {
        indicator.style.display = 'none';
        badge.style.display = 'none';
      }
    }

    function updateEmergencyUI(status) {
      // Update status badge
      const statusBadge = document.getElementById('emergency-status-badge');
      const statusText = document.getElementById('emergency-status-text');

      if (status.status === 'active') {
        statusBadge.className = 'status-badge connected';
        statusText.textContent = 'RECORDING';
      } else if (status.status === 'paused') {
        statusBadge.className = 'status-badge connecting';
        statusText.textContent = 'PAUSED';
      } else {
        statusBadge.className = 'status-badge disconnected';
        statusText.textContent = 'STOPPED';
      }

      // Update stats
      if (status.stats) {
        document.getElementById('emergency-stat-captures').textContent = status.stats.total_captures || 0;
        document.getElementById('emergency-stat-failed').textContent = status.stats.failed_captures || 0;
        document.getElementById('emergency-stat-storage').textContent = `${status.stats.storage_mb || 0} MB`;

        if (status.stats.last_capture_at) {
          const lastCapture = new Date(status.stats.last_capture_at);
          document.getElementById('emergency-stat-last').textContent = lastCapture.toLocaleTimeString();
        }
      }

      // Update buttons
      document.getElementById('emergency-start-btn').disabled = true;
      document.getElementById('emergency-stop-btn').disabled = false;
      document.getElementById('emergency-pause-btn').disabled = status.status === 'paused';
      document.getElementById('emergency-pause-btn').textContent = status.status === 'paused' ? 'Resume' : 'Pause';
      document.getElementById('emergency-export-btn').disabled = false;
      document.getElementById('emergency-cleanup-btn').disabled = false;

      // Update camera status grid
      if (status.cameras) {
        updateEmergencyCameraStatus(status.cameras, status.stats);
      }

      // Load snapshots
      loadEmergencySnapshots();
    }

    function resetEmergencyUI() {
      document.getElementById('emergency-status-badge').className = 'status-badge disconnected';
      document.getElementById('emergency-status-text').textContent = 'STOPPED';
      document.getElementById('emergency-stat-captures').textContent = '0';
      document.getElementById('emergency-stat-failed').textContent = '0';
      document.getElementById('emergency-stat-storage').textContent = '0 MB';
      document.getElementById('emergency-stat-last').textContent = '--';

      document.getElementById('emergency-start-btn').disabled = false;
      document.getElementById('emergency-stop-btn').disabled = true;
      document.getElementById('emergency-pause-btn').disabled = true;
      document.getElementById('emergency-pause-btn').textContent = 'Pause';
      document.getElementById('emergency-export-btn').disabled = true;
      document.getElementById('emergency-cleanup-btn').disabled = true;
    }

    function updateEmergencyCameraList() {
      const cameras = getCurrentCameras();
      const container = document.getElementById('emergency-camera-list');
      const countSpan = document.getElementById('emergency-camera-count');

      countSpan.textContent = cameras.length;

      if (cameras.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 20px;">
            <div class="empty-state-text">No cameras in current site</div>
          </div>
        `;
        return;
      }

      container.innerHTML = cameras.map(cam => `
        <div style="display: flex; align-items: center; padding: 8px; background: var(--bg-primary); border-radius: 4px; margin-bottom: 5px;">
          <span style="color: var(--orange-glow); margin-right: 10px;">${escapeHtml(cam.id)}</span>
          <span style="color: var(--text-dim);">${escapeHtml(cam.ip)}</span>
          ${cam.username ? '<span style="color: var(--green-terminal); margin-left: auto; font-size: 0.7rem;">AUTH</span>' : '<span style="color: var(--red-alert); margin-left: auto; font-size: 0.7rem;">NO AUTH</span>'}
        </div>
      `).join('');
    }

    function updateEmergencyCameraStatus(cameras, stats) {
      const container = document.getElementById('emergency-camera-status-grid');

      container.innerHTML = cameras.map(cam => `
        <div class="camera-status-card ${stats?.cameras_active > 0 ? 'active' : 'failed'}">
          <div style="font-size: 0.75rem; color: var(--orange-glow); margin-bottom: 5px;">${escapeHtml(cam.name || cam.id)}</div>
          <div style="font-size: 0.65rem; color: var(--text-dim);">${escapeHtml(cam.ip)}</div>
        </div>
      `).join('');
    }

    async function loadEmergencySnapshots() {
      const site = getCurrentSite();
      if (!site) return;

      try {
        const response = await fetch(`${API_BASE}/api/emergency-record/snapshots/${site.id}?limit=20`);
        const data = await response.json();

        const grid = document.getElementById('emergency-snapshots-grid');
        const empty = document.getElementById('emergency-snapshots-empty');

        if (data.snapshots && data.snapshots.length > 0) {
          empty.style.display = 'none';
          grid.innerHTML = data.snapshots.map(snap => `
            <div class="snapshot-thumbnail" onclick="viewEmergencySnapshot(${snap.id})">
              <img src="${API_BASE}/api/emergency-record/snapshot/${snap.id}" alt="Snapshot" loading="lazy" />
              <div class="snapshot-thumbnail-overlay">
                <div class="snapshot-thumbnail-camera">${escapeHtml(snap.camera_id)}</div>
                <div class="snapshot-thumbnail-time">${new Date(snap.captured_at).toLocaleTimeString()}</div>
              </div>
            </div>
          `).join('');
        } else {
          empty.style.display = 'block';
          grid.innerHTML = '';
        }
      } catch (error) {
        console.error('Failed to load snapshots:', error);
      }
    }

    function viewEmergencySnapshot(snapshotId) {
      window.open(`${API_BASE}/api/emergency-record/snapshot/${snapshotId}`, '_blank');
    }

    async function startEmergencyRecording() {
      const site = getCurrentSite();
      if (!site) {
        showToast('No site selected');
        return;
      }

      // Build cameras with credentials - check camera object first, then sessionCredentials fallback
      const allCameras = getCurrentCameras();
      const camerasWithCreds = allCameras.map(cam => {
        // Use stored credentials on camera object, or fall back to session cache
        const creds = sessionCredentials[cam.ip];
        return {
          ...cam,
          username: cam.username || creds?.username,
          password: cam.password || creds?.password
        };
      }).filter(cam => cam.username && cam.password);

      if (camerasWithCreds.length === 0) {
        showToast('No cameras with credentials. Re-add cameras with "Remember" checked.');
        return;
      }

      const interval = parseInt(document.getElementById('emergency-interval').value);
      const retention = parseInt(document.getElementById('emergency-retention').value);

      try {
        const response = await fetch(`${API_BASE}/api/emergency-record/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            site_id: site.id,
            cameras: camerasWithCreds.map(cam => ({
              id: cam.id,
              ip: cam.ip,
              port: cam.port || 80,
              username: cam.username,
              password: cam.password,
              name: cam.name || cam.id
            })),
            interval_seconds: interval,
            retention_hours: retention
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast('Emergency recording started');
          startEmergencyStatusPolling();
          fetchEmergencyStatus();
        } else {
          showToast(result.message || 'Failed to start recording');
        }
      } catch (error) {
        console.error('Failed to start emergency recording:', error);
        showToast('Failed to start recording');
      }
    }

    async function stopEmergencyRecording() {
      const site = getCurrentSite();
      if (!site) return;

      try {
        const response = await fetch(`${API_BASE}/api/emergency-record/stop/${site.id}`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          showToast('Emergency recording stopped');
          emergencyRecordingActive = false;
          updateEmergencyIndicator(false);
          resetEmergencyUI();
        }
      } catch (error) {
        console.error('Failed to stop emergency recording:', error);
        showToast('Failed to stop recording');
      }
    }

    async function pauseResumeEmergencyRecording() {
      const site = getCurrentSite();
      if (!site) return;

      const isPaused = document.getElementById('emergency-pause-btn').textContent === 'Resume';
      const endpoint = isPaused ? 'resume' : 'pause';

      try {
        const response = await fetch(`${API_BASE}/api/emergency-record/${endpoint}/${site.id}`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          showToast(`Recording ${isPaused ? 'resumed' : 'paused'}`);
          fetchEmergencyStatus();
        }
      } catch (error) {
        console.error(`Failed to ${endpoint} emergency recording:`, error);
      }
    }

    async function exportEmergencySnapshots() {
      const site = getCurrentSite();
      if (!site) return;

      try {
        const response = await fetch(`${API_BASE}/api/emergency-record/export/${site.id}`);
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `emergency_snapshots_${site.id}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          showToast('Export downloaded');
        } else {
          showToast('No snapshots to export');
        }
      } catch (error) {
        console.error('Failed to export snapshots:', error);
        showToast('Export failed');
      }
    }

    async function cleanupEmergencySnapshots() {
      const site = getCurrentSite();
      if (!site) return;

      const retention = parseInt(document.getElementById('emergency-retention').value);

      try {
        const response = await fetch(`${API_BASE}/api/emergency-record/snapshots/${site.id}?older_than_hours=${retention}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showToast(`Cleaned up ${result.deleted_count} snapshots (${result.freed_mb} MB freed)`);
          loadEmergencySnapshots();
        }
      } catch (error) {
        console.error('Failed to cleanup snapshots:', error);
        showToast('Cleanup failed');
      }
    }

    // Emergency Record Event Listeners
    document.getElementById('emergency-start-btn')?.addEventListener('click', startEmergencyRecording);
    document.getElementById('emergency-stop-btn')?.addEventListener('click', stopEmergencyRecording);
    document.getElementById('emergency-pause-btn')?.addEventListener('click', pauseResumeEmergencyRecording);
    document.getElementById('emergency-export-btn')?.addEventListener('click', exportEmergencySnapshots);
    document.getElementById('emergency-cleanup-btn')?.addEventListener('click', cleanupEmergencySnapshots);

    // Update camera list when Emergency section is shown
    document.querySelector('.nav-item[data-section="emergency"]')?.addEventListener('click', () => {
      updateEmergencyCameraList();
      if (emergencyRecordingActive) {
        fetchEmergencyStatus();
      }
    });

    // Check for active recording on page load
    function initEmergencyRecord() {
      const site = getCurrentSite();
      if (site) {
        fetchEmergencyStatus().then(() => {
          if (emergencyRecordingActive) {
            startEmergencyStatusPolling();
          }
        });
      }
    }

    // ---- Initialize ----
    loadState();
    initEmergencyRecord();
  </script>
</body>
</html>
